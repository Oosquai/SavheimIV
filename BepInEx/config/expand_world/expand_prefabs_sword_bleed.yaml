###############################################################
# Sword bleeds
# Secondary attacks from swords and greatswords cause bleed against staggered enemies.
# Reapplications reset count and add a second set of ticks, for stacking damage.
# More stacks makes ticks faster too though, so can't stack infinitely.
# Damage scales roughly with creature max hp, at about 1% total hp per tick, up to a cap.
# 1h swords get 10 ticks, for 10% damage and 10 seconds to keep building stacks.
# Greatswords get 13 ticks, for 13% damage and 13 seconds to keep building stacks.

# 2h sword attack
- prefab: sfx_build_cultivator      # Wacky's Database used to trigger this on secondary attack hit for 1h swords.
  type: create
  objects:
  - sfx_sword_hit, 1
  - sfx_perfectblock, 5             # Only trigger after parry.  sfx shortened to 3s in expand_prefabs.yaml.  need range in case player moves after parry
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 9                  # big range for big creatures
    parameter: p_sword_bleed_hp 12  # par1 = total ticks minus 1

# 1h sword attack
- prefab: sfx_build_hoe             # Wacky's Database used to trigger this on secondary attack hit for 1h swords.
  type: create
  objects:
  - sfx_sword_hit, 1
  - sfx_perfectblock, 5             # Only trigger after parry.  sfx shortened to 3s in expand_prefabs.yaml.  need range in case player moves after parry
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 9                  # big range for big creatures
    parameter: p_sword_bleed_hp 9   # par1 = total ticks minus 1

# Check max hp of creature, set ticks to a bit over 1%, capping out at X dmg/tick
- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1;99
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 1  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 100;199
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 2  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 200;299
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 3  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 300;399
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 4  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 400;499
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 5  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 500;599
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 6  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 600;699
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 7  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 700;799
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 8  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 800;899
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 9  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 900;999
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 10  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1000;1099
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 11  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1100;1199
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 12  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1200;1299
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 13  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1300;1399
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 14  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1400;1499
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 15  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1500;1599
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 16  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1600;1699
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 17  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1700;1799
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 18  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1800;99999    # MAX
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1> 19  # ticks, dmg per tick

# Bleed fx
- prefab: creature
  type: poke, p_sword_bleed_fx
  data: d_bleed_tick_rst_stack_inc     # reset tick count and increment stack count any time a new stack is created
  injectData: true
  spawns:
  - fx_bloodweapon_hit, 0,0,1, 0,0,0, d_empty_data_sb, 0.06
  - fx_bloodweapon_hit, 0,0,1.6, 0,0,0, d_empty_data_sb, 0.12
  - fx_bloodweapon_hit, 0,0,2.2, 0,0,0, d_empty_data_sb, 0.18
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_sb, 0
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_sb, 0.4
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_sb, 0.8
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_loop <par1> <par2>+<par2>*<int_i_bleed_stack_cnt>

# Main Bleed Loop.  Count to X, then exit.
- prefab: creature
  type: poke, p_sword_bleed_loop
  filter: int, i_bleed_tick_cnt, 0;<par1>   # check tick count
  data: d_bleed_tick_cnt_inc                # increment tick count and clear i_bleed_stack_timeout flag
  injectData: true
  objectRpc:
  - name: RPC_Damage
    1: hit, damage=<par2>                   # apply tick damage
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    delay: 1
    parameter: p_sword_bleed_loop <par1> <par2>  # self loop

# once count exceeds limit, fallback process will clear all stacks
- prefab: creature
  type: poke, p_sword_bleed_loop
  data: d_bleed_stack_timeout_set  # attempt to clear all bleed state. will only succeed if no other poke loops still active.
  injectData: true
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    delay: 1.1                     # need this delay to clear all stacks
    parameter: p_sword_bleed_clear
  fallback: true

# clear bleed stacks
- prefab: creature
  type: poke, p_sword_bleed_clear
  filter: int, i_bleed_stack_timeout, 1
  data: d_bleed_full_rst
  injectData: true
