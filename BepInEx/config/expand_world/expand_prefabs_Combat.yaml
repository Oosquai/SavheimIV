###############################################################
# Savheim Combat Mechanics - prefabs
###############################################################
# Exotic player states
# Parry
- prefab: sfx_perfectblock
  type: create
  removeDelay: 3   # shorten duration for use as trigger in bleed logic
  remove: true
  bannedObjects:
  - Player, 1, PlayerBlockingHuntressBow
  poke:
  - prefab: Player
    data: PlayerBlocking
    limit: 1
    maxDistance: 1
    parameter: PlayerParry

#####################
# Block
- prefab: vfx_blocked
  type: create
  poke:
  - prefab: Player
    data: PlayerBlocking
    limit: 1
    maxDistance: 6
    parameter: PlayerBlock
  - prefab: Player
    data: PlayerBlockingShield
    limit: 1
    maxDistance: 6
    parameter: p_shield_counter_start

###############################################################
# Shield Counter
- prefab: Player
  type: poke, p_shield_counter_start
  bannedObjects:
  - sfx_perfectblock, 1
  data: d_player_shield_counter_on
  injectData: true
  poke:
  - self: true
    delay: 0.3      # time to activate attack after block.  Testing showed 0.15 minimum in local game.  Maybe 0.2 if too tight online?
    parameter: p_shield_counter_end

- prefab: Player
  type: poke, p_shield_counter_end
  data: d_player_shield_counter_off
  injectData: true

- prefab: Player
  types:
  - state, swing_axe0
  - state, swing_longsword0
  - state, spear_poke
  - state, unarmed_attack0
  filter: d_player_shield_counter_on
  poke:
  - self: true
    parameter: p_shield_counter_fx

# special process for knives, since so much faster than other weapons
- prefab: Player
  types:
  - state, knife_stab0
  filter: d_player_shield_counter_on
  poke:
  - self: true
    parameter: p_shield_counter_fx_knife

# special process for Rikarr's rapier since it uses different attacks.  trigger off secondary slash.
- prefab: Player
  types:
  - state, swing_longsword1
  filter: d_player_shield_counter_on_rikarr
  poke:
  - self: true
    parameter: p_shield_counter_fx

# shield counter effects
- prefab: Player
  type: poke, p_shield_counter_fx
  data: d_player_shield_counter_off   # failsafe to ensure only one buffed attack
  injectData: true
  spawns:
  - sfx_kromsword_swing, 0,0,0, 0,0,0, shield_counter_attack_pitch_low, 0
  - sfx_kromsword_swing, 0,0,0, 0,0,0, d_empty_data_combat, 0.15
  - sfx_kromsword_swing, 0,0,0, 0,0,0, shield_counter_attack_pitch_high, 0.3
  - vfx_crossbow_nature_fire, -0.5,0,0.7, 40,0,60, d_empty_data_combat, 0.3
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_Shield_Counter
    2: bool, true
    3: int, 1
    4: float, 1
    delay: 0.15  # set to just less than fastest possible wind-up of spears (fastest).  +20 spear with perfect purple and redish gems sometimes failed to boosted damage at 0.2.

# shield counter effects - knives (faster)
- prefab: Player
  type: poke, p_shield_counter_fx_knife
  data: d_player_shield_counter_off   # failsafe to ensure only one buffed attack
  injectData: true
  spawns:
  - sfx_kromsword_swing, 0,0,0, 0,0,0, shield_counter_attack_pitch_low, 0
  - sfx_kromsword_swing, 0,0,0, 0,0,0, shield_counter_attack_pitch_high, 0.1
  - vfx_crossbow_nature_fire, -0.5,0,0.7, 40,0,60, d_empty_data_combat, 0.1
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_Shield_Counter_Knife
    2: bool, true
    3: int, 1
    4: float, 1
    delay: 0.05

###############################################################
# Spirit Counter
- prefab: Player
  type: state, swing_longsword1
  filter: gear_staffshield_all
  poke:
  - self: true
    parameter: p_spirit_counter

- prefab: Player
  type: poke, p_spirit_counter
  data: d_spirit_counter_on
  injectData: true
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_Staff_shield_Spirit_Counter
    2: bool, true
    3: int, 1
    4: float, 1
  poke:
  - self: true
    delay: 0.3                      # must match TtL of SE_Savheim_Staff_shield_Spirit_Counter
    parameter: p_spirit_counter_off

- prefab: Player
  type: poke, p_spirit_counter_off
  data: d_spirit_counter_off
  injectData: true

- prefab: fx_StaffShield_Break
  type: create
  objects:
  - Player, 1, d_spirit_counter_t2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_spirit_counter_AE <randi_22_26> <vec>  # higher than same tier sanctis, since this requires parry timing and sacrifices shield
    maxDistance: 4
    limit: 3

- prefab: fx_StaffShield_Break
  type: create
  objects:
  - Player, 1, d_spirit_counter_t4
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_spirit_counter_AE <randi_45_51> <vec>
    maxDistance: 4
    limit: 3

- prefab: fx_StaffShield_Break
  type: create
  objects:
  - Player, 1, d_spirit_counter_t6
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_spirit_counter_AE <randi_68_74> <vec>
    maxDistance: 4
    limit: 3

# Spirit Counter Spirit & Stagger AE
- prefab: creature
  type: poke, p_spirit_counter_AE
  filter: not_tamed_combat
  objectRpc:
  - name: RPC_Damage
    1: hit, spirit=<par1>
  poke:
  - self: true
    delay: 0.1           # needed on server to trigger stagger
    parameter: p_spirit_counter_AE_fx <par2>

- prefab: creature
  type: poke, p_spirit_counter_AE_fx
  objects:
  - sfx_UndeadBurn_Start, 1
  spawn: fx_Fader_Roar
  objectRpc:
  - name: RPC_Stagger
    1: vec, <par1>

###############################################################
# Results of exotic player states
###############################################################
# Aegis parry
- prefab: Player
  type: poke, PlayerParry
  filter: aegisShieldList
  spawn: fx_DvergerMage_Mistile_die
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_Aegis_Eitr_Regen
    2: bool, true
    3: int, 1
    4: float, 1

###############################################################
# Buckler parry - speed burst
- prefab: Player
  type: poke, PlayerParry
  filter: bucklerShieldList
  spawns:
  - sfx_start_buff_2
  - vfx_ColdBall_launch
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_BucklerShield_Speed_Burst
    2: bool, true
    3: int, 1
    4: float, 1

###############################################################
# Round parry - stamina regen
- prefab: Player
  type: poke, PlayerParry
  filter: roundShieldList
  spawns:
  - sfx_metal_blocked_overlay
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_RoundShield_Stam_Regen
    2: bool, true
    3: int, 1
    4: float, 1

###############################################################
# Tower block - HP regen
- prefab: Player
  type: poke, PlayerBlock
  filter: towerShieldList
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_TowerShield_HP_Regen
    2: bool, true
    3: int, 1
    4: float, 1

###############################################################
# Shortbow acrobatics - thanks DhakhaR!
- prefab: Player
  type: state, jump
  filter: shortBowList
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, dodge
    delay: 0.15

#####################
# Shortbow speed burst
- prefab: Player
  type: state, bow_fire
  filter: shortBowList
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_Shortbow_Speed_Burst
    2: bool, true
    3: int, 1
    4: float, 1

###############################################################
# Longbow jump shot
- prefab: sfx_bow_draw
  type: create
  objects:
  - Player, 1, d_player_airborne_longbow
  poke:
  - prefab: Player
    limit: 1
    maxDistance: 1
    data: d_player_airborne_longbow
    parameter: p_longbow_jump_shot

- prefab: Player
  type: poke, p_longbow_jump_shot
  filter: d_player_airborne_longbow
  data: d_longbow_jump_shot_cd_on
  injectData: true
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_LongbowSkill
    2: bool, true
    3: int, 1
    4: float, 1
  poke:
  - self: true
    delay: 3
    parameter: p_longbow_jump_cd_off

- prefab: Player
  type: poke, p_longbow_jump_cd_off
  data: d_longbow_jump_shot_cd_off
  injectData: true

- prefab: Player
  type: state, jump
  filter: d_longbow_jump_shot_cd_on
  data: d_longbow_jump_shot_cd_off
  injectData: true

###############################################################
# Spear speed burst after throw
- prefab: Player
  type: state, spear_throw
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_Spear_Throw_Speed_Burst
    2: bool, true
    3: int, 1
    4: float, 1

###############################################################
# Vanish after knife kill
- prefab: creature
  type: destroy
  fallback: true
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_combat
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_combat

- prefab: sfx_build_table
  type: create
  removeDelay: 1                                 ### TRIGGER WINDOW.  Reduce to enforce reaction time and prevent double leap
  remove: true

- prefab: Player
  types:
  - state, knife_secondary
  - state, dual_knives_secondary
  objects:
  - sfx_arrow_hit, 6
  - sfx_knife_swing, 6
  - sfx_gui_craftitem_cauldron, 6
  - sfx_build_table, 6
  spawns:
  - fx_DvergerMage_Mistile_die
  - vfx_wraith_death
  - vfx_ghost_death, 0,0,1, 0,0,0, d_empty_data_combat, 0.1
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_Vanish
    2: bool, true
    3: int, 1
    4: float, 1
  poke:
  - prefab: creature
    maxDistance: 4                               ### RANGE WITHIN WHICH CREATURES AFFECTED
    parameter: p_vanish_deaggro

- prefab: creature
  type: poke, p_vanish_deaggro
  data: d_vanish_deaggro
  injectData: true              # need inject to avoid respawn
  owner: 0                      # need to remove ownership to force inject to recognize new data

###############################################################
# Bleed Mechanics
# Secondary attacks from swords and greatswords cause bleed against staggered enemies.
# Greatswords get more ticks than 1h swords.
# Claw primary attacks have a chance to trigger bleed, but with shorter duration.
# Bleed arrows and bolts always bleed, but much shorter duration.
# Reapplications stack damage and add small amounts of extra ticks.
# Damage scales roughly with creature max hp.

# 1h swords
- prefab: sfx_open_box              # Wacky's Database SE adds this, to ensure only occurs on hit.
  type: create
  objects:
  - sfx_build_hoe, 1                # Wacky's Database SE sfx added to secondary attacks of 1h swords only
  - sfx_perfectblock, 7             # Only trigger after parry.  sfx shortened to 3s in expand_prefabs.yaml.  need range in case player moves after parry
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6                  # big range for big creatures (troll 2.  bonemass 4.  8-star bonemass 6)
    parameter: p_sword_bleed_hp 6 2 0.25   # base total ticks minus 1 | ticks added per additional stack | power used to scale max hp - higher is exponentially more damage

# 2h swords
- prefab: sfx_open_box
  type: create
  objects:
  - sfx_build_cultivator, 1         # specific to greatswords
  - sfx_perfectblock, 7
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 10 3 0.285

# claws - chance to bleed on primary attacks.  this is also used with Ryvers (CWS_Sword_5_SH).
# chance achieved with Wacky's Database chance to proc SE on attack
- prefab: sfx_open_box              # Wacky's Database SE adds this, to ensure only occurs on hit.
  type: create
  objects:
  - sfx_gui_craftitem_end, 1        # specific to claws and Ryvers
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 4 2 0.25   # rapid short-duration bleeds

# bleed arrows and bolts
- prefab: sfx_open_box
  type: create
  objects:
  - sfx_gui_craftitem, 1               # specific to bleed arrows and bolts
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 4 2 0.25   # on-demand bleed arrows have short duration and limited stacking

# unique melee bow - huntress.  bleeds on parry.
- prefab: sfx_perfectblock
  type: create
  removeDelay: 3   # shorten duration for use as trigger in bleed logic
  remove: true
  objects:
  - Player, 1, PlayerBlockingHuntressBow
  weight: 0.6
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 4 2 0.25

##########################
# Bleed Inits
# Some creatures don't bleed - Intercept with no-op
- prefab: Skeleton, Skeleton_Poison, Skeleton_Hildir, Ghost, Wraith, StoneGolem, GoblinKing, Charred_Archer, Charred_Melee, Charred_Mage, Charred_Twitcher, Charred_Twitcher_Summoned, Morgen, Troll_Summoned
  type: poke, p_sword_bleed_hp
  weight: 1E30

# Creature not yet bleeding - init loop
- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: int, i_bleed_active, 0       # not already bleeding.  init and start loop
  data: d_combat_bleed_init
  injectData: true
  spawns:
  - fx_bloodweapon_hit, 0,0,1, 0,0,0, d_empty_data_combat, 0.05
  - fx_bloodweapon_hit, 0,0,1.6, 0,0,0, d_empty_data_combat, 0.1
  - fx_bloodweapon_hit, 0,0,2.2, 0,0,0, d_empty_data_combat, 0.15
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_combat, 0
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_combat, 0.4
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_combat, 0.8
  poke:
  - self: true
    delay: 1
    parameter: p_combat_bleed_loop <par3>

# Creature already bleeding - increase stack count and max tick count but don't add new loop
- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: int, i_bleed_active, 1       # already bleeding.  add stack and extend
  data: d_combat_bleed_add_stack
  injectData: true
  spawns:
  - fx_bloodweapon_hit, 0,0,1, 0,0,0, d_empty_data_combat, 0.05
  - fx_bloodweapon_hit, 0,0,1.6, 0,0,0, d_empty_data_combat, 0.1
  - fx_bloodweapon_hit, 0,0,2.2, 0,0,0, d_empty_data_combat, 0.15
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_combat, 0
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_combat, 0.4
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data_combat, 0.8

##########################
### MAIN BLEED LOOP
- prefab: creature
  type: poke, p_combat_bleed_loop
  filter: int, i_bleed_tick_cnt, 1;99999
  data: d_combat_bleed_tick_cnt_dec
  injectData: true
  objectRpc:
  - name: RPC_Damage
    1: hit, damage=<mul_<randf_0.9_1.1>_<mul_<pow_<float_max_health>_<par1>>_<int_i_bleed_stack_cnt>>>  ### TICK DMG = stacks x max hp raised to 0.25
    delay: 0.1
  poke:
  - self: true
    delay: 1                                     ### TICK TIME
    parameter: p_combat_bleed_loop <par1>
#### DEBUG - COMMENT OUT ###
#  command: s <int_i_bleed_tick_cnt> tcks. <int_i_bleed_stack_cnt> stks. <round_<float_health>> hp
############################

# Clear bleeding state
- prefab: creature
  type: poke, p_combat_bleed_loop
  fallback: true
  data: d_combat_bleed_end
  injectData: true

################################################################
# Sanctis - 1h sword class, eitr-based
# Players shield themselves on secondary attack of any Sanctis.
# Shield has 5 hp and lasts 1 minute.
# Also spawns AE spirit damage.
- prefab: Player
  type: state, staff_summon
  filter: gear_sanctis_t2
  spawn: fx_DvergerMage_Mistile_attack
  delay: 0.2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_sanctis_spiritAE <randi_17_19>
    maxDistance: 4
    delay: 0.4
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_StaffShield_SH
    2: bool, true
    3: int, 1
    4: float, -9.8
    delay: 0.3

- prefab: Player
  type: state, staff_summon
  filter: gear_sanctis_t3
  spawn: fx_DvergerMage_Mistile_attack
  delay: 0.2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_sanctis_spiritAE <randi_28_32>
    maxDistance: 4
    delay: 0.4
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_StaffShield_SH
    2: bool, true
    3: int, 1
    4: float, -9.8
    delay: 0.3

- prefab: Player
  type: state, staff_summon
  filter: gear_sanctis_t4
  spawn: fx_DvergerMage_Mistile_attack
  delay: 0.2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_sanctis_spiritAE <randi_40_44>
    maxDistance: 4
    delay: 0.4
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_StaffShield_SH
    2: bool, true
    3: int, 1
    4: float, -9.8
    delay: 0.3

- prefab: Player
  type: state, staff_summon
  filter: gear_sanctis_t5
  spawn: fx_DvergerMage_Mistile_attack
  delay: 0.2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_sanctis_spiritAE <randi_51_57>
    maxDistance: 4
    delay: 0.4
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_StaffShield_SH
    2: bool, true
    3: int, 1
    4: float, -9.8
    delay: 0.3

- prefab: Player
  type: state, staff_summon
  filter: gear_sanctis_t6
  spawn: fx_DvergerMage_Mistile_attack
  delay: 0.2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_sanctis_spiritAE <randi_63_69>
    maxDistance: 4
    delay: 0.4
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_StaffShield_SH
    2: bool, true
    3: int, 1
    4: float, -9.8
    delay: 0.3

- prefab: Player
  type: state, staff_summon
  filter: gear_sanctis_t7
  spawn: fx_DvergerMage_Mistile_attack
  delay: 0.2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_sanctis_spiritAE <randi_68_76>
    maxDistance: 4
    delay: 0.4
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_StaffShield_SH
    2: bool, true
    3: int, 1
    4: float, -9.8
    delay: 0.3

- prefab: Player
  type: state, staff_summon
  filter: gear_sanctis_t8
  spawn: fx_DvergerMage_Mistile_attack
  delay: 0.2
  poke:
  - prefab: creature
    data: not_tamed_combat
    parameter: p_sanctis_spiritAE <randi_80_88>
    maxDistance: 4
    delay: 0.4
  objectRpc:
  - name: RPC_AddStatusEffect
    1: hash, SE_Savheim_StaffShield_SH
    2: bool, true
    3: int, 1
    4: float, -9.8
    delay: 0.3

# Sanctis spirit AE
- prefab: creature
  type: poke, p_sanctis_spiritAE
  filter: not_tamed_combat
  objectRpc:
  - name: RPC_Damage
    1: hit, spirit=<par1>
  poke:
  - self: true
    delay: 0.1
    parameter: p_sanctis_spiritAE_fx

- prefab: creature
  type: poke, p_sanctis_spiritAE_fx
  objects:
  - sfx_UndeadBurn_Start, 1
  spawn: fx_Fader_Roar_Projectile_Hit

################################################################
# Reapers
# Primary X -> Secondary attacks have effects if they connect
# 1, 2 = Generate stacks on enemy
# 1, 1, 2 = Pop stacks for heal
# 1, 1, 1, 2 = Pop stacks for damage
## set flags when player primary attacks with a reaper, distinguishing between 1st, 2nd, and 3rd animations
- prefab: Player
  type: state, greatsword0
  filter: d_reaper_list
  data: d_state_reaper0_set
  injectData: true
  poke:
  - self: true
    delay: 0.7                                   # time needed for primary hit to land
    parameter: p_state_reaper0_clr

- prefab: Player                                 # clear flag after a delay
  type: poke, p_state_reaper0_clr
  data: d_state_reaper0_clr
  injectData: true

- prefab: Player
  type: state, greatsword1
  filter: d_reaper_list
  data: d_state_reaper1_set
  injectData: true
  poke:
  - self: true
    delay: 0.7                                   # time needed for primary hit to land
    parameter: p_state_reaper1_clr

- prefab: Player
  type: poke, p_state_reaper1_clr
  data: d_state_reaper1_clr
  injectData: true

- prefab: Player
  type: state, greatsword2
  filter: d_reaper_list
  data: d_state_reaper2_set
  injectData: true
  poke:
  - self: true
    delay: 0.7                                   # time needed for primary hit to land
    parameter: p_state_reaper2_clr

- prefab: Player
  type: poke, p_state_reaper2_clr
  data: d_state_reaper2_clr
  injectData: true

## Detect reaper primary attack making contact, poke if animation flagged
- prefab: sfx_cinder_rain_hit
  type: create
  objects:
  - Player, 6, d_reaper_list
  - sfx_sword_hit, 1
  poke:
  - prefab: Player
    maxDistance: 6
    limit: 1
    data: d_state_reaper0_filter                 # animation flag check
    parameter: p_state_reaper0_latched
  - prefab: Player
    maxDistance: 6
    limit: 1
    data: d_state_reaper1_filter
    parameter: p_state_reaper1_latched
  - prefab: Player
    maxDistance: 6
    limit: 1
    data: d_state_reaper2_filter
    parameter: p_state_reaper2_latched

## Latch state on player that a specific reaper attack made contact
- prefab: Player
  type: poke, p_state_reaper0_latched
  data: d_state_reaper0_latched_set
  injectData: true
  poke:
  - self: true
    delay: 0.53                                  # time needed to start secondary attack
    parameter: p_state_reaper0_latched_clr

- prefab: Player                                 # clear flag after a delay
  type: poke, p_state_reaper0_latched_clr
  data: d_state_reaper0_latched_clr
  injectData: true

- prefab: Player
  type: poke, p_state_reaper1_latched
  data: d_state_reaper1_latched_set
  injectData: true
  poke:
  - self: true
    delay: 0.7                                   # time needed to start secondary attack
    parameter: p_state_reaper1_latched_clr

- prefab: Player
  type: poke, p_state_reaper1_latched_clr
  data: d_state_reaper1_latched_clr
  injectData: true

- prefab: Player
  type: poke, p_state_reaper2_latched
  data: d_state_reaper2_latched_set
  injectData: true
  poke:
  - self: true
    delay: 1.1                                   # time needed to start secondary attack
    parameter: p_state_reaper2_latched_clr

- prefab: Player
  type: poke, p_state_reaper2_latched_clr
  data: d_state_reaper2_latched_clr
  injectData: true

## Detect Reaper Secondary attack after 1st primary.  poke creatures to set up for hit fx.
- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper0_latched_filter
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo0_pending

- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper1_latched_filter
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo1_pending

# final combo needs to determine which tier reaper player is using to calculate dmg
- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper2_latched_filter_t3
  data: d_reaping_player_set
  injectData: true
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo2_pending 1         # <par1> is dmg multiplier for final combo
  - self: true
    delay: 0.7
    parameter: p_reaping_player_rst

- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper2_latched_filter_t4
  data: d_reaping_player_set
  injectData: true
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo2_pending 2
  - self: true
    delay: 0.7
    parameter: p_reaping_player_rst

- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper2_latched_filter_t5
  data: d_reaping_player_set
  injectData: true
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo2_pending 3
  - self: true
    delay: 0.7
    parameter: p_reaping_player_rst

- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper2_latched_filter_t6
  data: d_reaping_player_set
  injectData: true
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo2_pending 4
  - self: true
    delay: 0.7
    parameter: p_reaping_player_rst

- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper2_latched_filter_t7
  data: d_reaping_player_set
  injectData: true
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo2_pending 5
  - self: true
    delay: 0.7
    parameter: p_reaping_player_rst

- prefab: Player
  type: state, battleaxe_attack2
  filter: d_state_reaper2_latched_filter_t8
  data: d_reaping_player_set
  injectData: true
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 3
    data: not_tamed_combat
    parameter: p_reaper_combo2_pending 6
  - self: true
    delay: 0.7
    parameter: p_reaping_player_rst

- prefab: Player
  type: poke, p_reaping_player_rst
  data: d_reaping_player_rst
  injectData: true

## Poke creatures to queue flags and queue up flag clears
- prefab: creature
  type: poke, p_reaper_combo0_pending
  data: d_reaper_combo0_pending_set
  injectData: true
  poke:
  - self: true
    delay: 0.7                                   # time for reaper 2nd attack to land
    parameter: p_reaper_combo0_pending_clr

- prefab: creature
  type: poke, p_reaper_combo0_pending_clr
  data: d_reaper_combo0_pending_clr
  injectData: true

- prefab: creature
  type: poke, p_reaper_combo1_pending
  data: d_reaper_combo1_pending_set
  injectData: true
  poke:
  - self: true
    delay: 0.7                                   # time for reaper 2nd attack to land
    parameter: p_reaper_combo1_pending_clr

- prefab: creature
  type: poke, p_reaper_combo1_pending_clr
  data: d_reaper_combo1_pending_clr
  injectData: true

- prefab: creature
  type: poke, p_reaper_combo2_pending
  data: d_reaper_combo2_pending_set_and_save_dmg
  injectData: true
  poke:
  - self: true
    delay: 0.7                                   # time for reaper 2nd attack to land
    parameter: p_reaper_combo2_pending_clr

- prefab: creature
  type: poke, p_reaper_combo2_pending_clr
  data: d_reaper_combo2_pending_clr
  injectData: true

## Trigger on reaper 2nd hit fx, then poke creatures with comboX_pending filters
- prefab: sfx_axe_flint_hit
  type: create
  objects:
  - Player, 6, d_reaper_list
  - sfx_sword_hit, 1
  poke:
  - prefab: creature
    maxDistance: 6
    limit: 1
    data: d_reaper_combo0_pending_set
    parameter: p_reaper_combo0_hit
  - prefab: creature
    maxDistance: 6
    limit: 1
    data: d_reaper_combo1_pending_set
    parameter: p_reaper_combo1_hit
  - prefab: creature
    maxDistance: 6
    limit: 1
    data: d_reaper_combo2_pending_set
    parameter: p_reaper_combo2_hit

### REAPER COMBOS
## Primary-Secondary Combo = Create debuff stacks on creatures, max 3
- prefab: creature
  type: poke, p_reaper_combo0_hit
  poke:
  - self: true
    parameter: p_reaper_debuff_stacks_set

# set stack 1
- prefab: creature
  type: poke, p_reaper_debuff_stacks_set
  filter: d_reaper_debuff_stack_cnt_0
  data: d_reaper_debuff_stack_1_set
  injectData: true
  spawns:
  - fx_bloodweapon_hit                           # only spawn debuff fx if adding a stack
  - sfx_leech_hit
  - sfx_gjall_idle_shiver
  poke:
  - self: true
    delay: 60                                    # REAPER DEBUFF STACK TtL
    parameter: p_reaper_debuff_stack_1_clr
  - self: true
    delay: 2.5
    parameter: p_reaper_debuff_stack_dot1

# set stack 2
- prefab: creature
  type: poke, p_reaper_debuff_stacks_set
  filter: d_reaper_debuff_stack_cnt_1
  data: d_reaper_debuff_stack_2_set
  injectData: true
  spawns:
  - fx_bloodweapon_hit
  - fx_radiation_hit, 0,0,1
  - sfx_leech_hit
  - sfx_gjall_idle_shiver
  poke:
  - self: true
    delay: 60                                    # REAPER DEBUFF STACK TtL
    parameter: p_reaper_debuff_stack_2_clr
  - self: true
    delay: 2.5
    parameter: p_reaper_debuff_stack_dot2
  
# set stack 3
- prefab: creature
  type: poke, p_reaper_debuff_stacks_set
  filter: d_reaper_debuff_stack_cnt_2
  data: d_reaper_debuff_stack_3_set
  injectData: true
  spawns:
  - fx_bloodweapon_hit
  - fx_jotunbane_hit, 0,0,1
  - sfx_leech_hit
  - sfx_gjall_idle_shiver
  poke:
  - self: true
    delay: 60                                    # REAPER DEBUFF STACK TtL
    parameter: p_reaper_debuff_stack_3_clr
  - self: true
    delay: 2.5
    parameter: p_reaper_debuff_stack_dot3

# clear stack 1
- prefab: creature
  type: poke, p_reaper_debuff_stack_1_clr
  data: d_reaper_debuff_stack_1_clr
  injectData: true

# clear stack 2
- prefab: creature
  type: poke, p_reaper_debuff_stack_2_clr
  data: d_reaper_debuff_stack_2_clr
  injectData: true

# clear stack 3
- prefab: creature
  type: poke, p_reaper_debuff_stack_3_clr
  data: d_reaper_debuff_stack_3_clr
  injectData: true

### Debuff stacks have a small dot, mostly to help indicate they're there.  Good idea, Matt!
- prefab: creature
  type: poke, p_reaper_debuff_stack_dot1
  filter: d_reaper_debuff_stack_cnt_1
  objectRpc:
  - name: RPC_Damage
    1: hit, damage=1
  poke:
  - self: true
    delay: 2.5
    parameter: p_reaper_debuff_stack_dot1
  
- prefab: creature
  type: poke, p_reaper_debuff_stack_dot2
  filter: d_reaper_debuff_stack_cnt_2
  objectRpc:
  - name: RPC_Damage
    1: hit, damage=2
  poke:
  - self: true
    delay: 2.5
    parameter: p_reaper_debuff_stack_dot2
  
- prefab: creature
  type: poke, p_reaper_debuff_stack_dot3
  filter: d_reaper_debuff_stack_cnt_3
  objectRpc:
  - name: RPC_Damage
    1: hit, damage=3
  poke:
  - self: true
    delay: 2.5
    parameter: p_reaper_debuff_stack_dot3
  
## Primary-Primary-Secondary Combo = Consume debuff stacks to heal self.  Low damage.
- prefab: creature
  type: poke, p_reaper_combo1_hit
  filter: d_reaper_debuff_stack_cnt_1            # 1 debuff stack
  data: d_reaper_debuff_stack_cnt_0              # clear all debuff stacks
  injectData: true
  spawns:
  - vfx_BloodHit, 0,0,1
  - fx_natureweapon_hit, 0,0,1
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, d_sfx_reaper_heal_pitch1
  poke:
  - prefab: Player
    maxDistance: 6
    limit: 1
    data: d_reaper_list
    parameter: p_reaper_player_heal 1

- prefab: creature
  type: poke, p_reaper_combo1_hit
  filter: d_reaper_debuff_stack_cnt_2            # 2 debuff stacks
  data: d_reaper_debuff_stack_cnt_0              # clear all debuff stacks
  injectData: true
  spawns:
  - vfx_BloodHit, 0,0,1
  - fx_natureweapon_hit, 0,0,1
  - fx_natureweapon_hit, 0,0,1.3, 0,0,0, d_empty_data, 0.3
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, d_sfx_reaper_heal_pitch1
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, d_sfx_reaper_heal_pitch2, 0.3
  poke:
  - prefab: Player
    maxDistance: 6
    limit: 1
    data: d_reaper_list
    parameter: p_reaper_player_heal 2

- prefab: creature
  type: poke, p_reaper_combo1_hit
  filter: d_reaper_debuff_stack_cnt_3            # 3 debuff stacks
  data: d_reaper_debuff_stack_cnt_0              # clear all debuff stacks
  injectData: true
  spawns:
  - vfx_BloodHit, 0,0,1
  - fx_natureweapon_hit, 0,0,1
  - fx_natureweapon_hit, 0,0,1.3, 0,0,0, d_empty_data, 0.3
  - fx_natureweapon_hit, 0,0,1.6, 0,0,0, d_empty_data, 0.6
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, d_sfx_reaper_heal_pitch1
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, d_sfx_reaper_heal_pitch2, 0.3
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, d_sfx_reaper_heal_pitch3, 0.6
  poke:
  - prefab: Player
    maxDistance: 6
    limit: 1
    data: d_reaper_list
    parameter: p_reaper_player_heal 3

# Heal player
- prefab: Player
  type: poke, p_reaper_player_heal
  poke:
  - self: true
    parameter: p_reaper_player_heal_rpcs <par1>*0.2*<float_max_health>  ### PERCENT OF MAX HEALTH TO HEAL PER DEBUFF STACK

- prefab: Player
  type: poke, p_reaper_player_heal_rpcs
  spawns:
  - fx_natureweapon_hit, 0,0,1.2, 0,0,0, d_empty_data_combat, 0.2
  objectRpc:
  - name: RPC_Heal
    1: float, <par1>
    2: bool, 1
  clientRpc:
  - name: RPC_DamageText
    packaged: true
    1: enum_damagetext, Heal
    2: vec, <x>,<z>,<y>+2
    3: string, <par1>
    4: bool, false

## Primary-Primary-Primary-Secondary Combo = Consume debuff stacks to burst dmg on target and spread stacks to nearby enemies
- prefab: creature
  type: poke, p_reaper_combo2_hit
  filter: d_reaper_debuff_stack_cnt_1            # 1 debuff stack
  data: d_reaper_debuff_stack_cnt_0              # clear all debuff stacks
  injectData: true
  spawns:
  - sfx_metal_blocked_overlay, 0,0,0, 0,0,0, d_sfx_reaper_dmg_pitch1
  - sfx_fallenvalkyrie_attack_spit_projectile, 0,0,0, 0,0,0, d_empty_data_combat, 0, true
  - sfx_troll_attack_hit, d_sfx_troll_attack_hit_pitch
  poke:
  - self: true
    parameter: p_reaper_damage <vReaperDmg1>
  - prefab: creature
    data: not_tamed_combat
    minDistance: 0.1
    maxDistance: 4
    limit: 4
    parameter: p_reaper_combo0_hit
  - prefab: Player
    limit: 1
    data: d_reaping_player_set
    parameter: p_reaping_blood_vfx_cnt_1

- prefab: creature
  type: poke, p_reaper_combo2_hit
  filter: d_reaper_debuff_stack_cnt_2            # 2 debuff stacks
  data: d_reaper_debuff_stack_cnt_0              # clear all debuff stacks
  injectData: true
  spawns:
  - sfx_metal_blocked_overlay, 0,0,0, 0,0,0, d_sfx_reaper_dmg_pitch2
  - sfx_fallenvalkyrie_attack_spit_projectile, 0,0,0, 0,0,0, d_empty_data_combat, 0, true
  - sfx_troll_attack_hit, d_sfx_troll_attack_hit_pitch
  poke:
  - self: true
    parameter: p_reaper_damage <vReaperDmg2>
  - prefab: creature
    data: not_tamed_combat
    minDistance: 0.1
    maxDistance: 5
    limit: 5
    parameter: p_reaper_combo0_hit
  - prefab: creature
    data: not_tamed_combat
    minDistance: 0.1
    maxDistance: 5
    limit: 5
    delay: 0.1
    parameter: p_reaper_combo0_hit
  - prefab: Player
    limit: 1
    data: d_reaping_player_set
    parameter: p_reaping_blood_vfx_cnt_2

- prefab: creature
  type: poke, p_reaper_combo2_hit
  filter: d_reaper_debuff_stack_cnt_3            # 3 debuff stacks
  data: d_reaper_debuff_stack_cnt_0              # clear all debuff stacks
  injectData: true
  spawns:
  - sfx_metal_blocked_overlay, 0,0,0, 0,0,0, d_sfx_reaper_dmg_pitch3
  - sfx_fallenvalkyrie_attack_spit_projectile, 0,0,0, 0,0,0, d_empty_data_combat, 0, true
  - sfx_troll_attack_hit, d_sfx_troll_attack_hit_pitch
  poke:
  - self: true
    parameter: p_reaper_damage <vReaperDmg3>
  - prefab: creature
    data: not_tamed_combat
    minDistance: 0.1
    maxDistance: 6
    limit: 6
    parameter: p_reaper_combo0_hit
  - prefab: creature
    data: not_tamed_combat
    minDistance: 0.1
    maxDistance: 6
    limit: 6
    delay: 0.1
    parameter: p_reaper_combo0_hit
  - prefab: creature
    data: not_tamed_combat
    minDistance: 0.1
    maxDistance: 6
    limit: 6
    delay: 0.2
    parameter: p_reaper_combo0_hit
  - prefab: Player
    limit: 1
    data: d_reaping_player_set
    parameter: p_reaping_blood_vfx_cnt_3

- prefab: creature
  type: poke, p_reaper_damage
  objectRpc:
  - name: RPC_Damage
    1: hit, slash=<par1>
    delay: 0.1

- prefab: Player
  type: poke, p_reaping_blood_vfx_cnt_1
  spawns:
  - vfx_boar_hit, 0,1.5,1.8
  - vfx_player_death, 0.5,1.5,1, 0,90,90, d_empty_data_combat, 0.05
  - vfx_player_death, -0.5,1.5,1, 0,90,270, d_empty_data_combat, 0.05

- prefab: Player
  type: poke, p_reaping_blood_vfx_cnt_2
  spawns:
  - vfx_boar_hit, 0,1.5,1.8
  - vfx_player_death, 0.5,1.5,1, 0,90,90, d_empty_data_combat, 0.05
  - vfx_player_death, -0.5,1.5,1, 0,90,270, d_empty_data_combat, 0.05
  - vfx_player_death, 0,1.5,1, 0,90,90, d_empty_data_combat, 0.1
  - vfx_player_death, 0,1.5,1, 0,90,270, d_empty_data_combat, 0.1

- prefab: Player
  type: poke, p_reaping_blood_vfx_cnt_3
  spawns:
  - vfx_boar_hit, 0,1.5,1.8
  - vfx_player_death, 0.5,1.5,1, 0,90,90, d_empty_data_combat, 0.05
  - vfx_player_death, -0.5,1.5,1, 0,90,270, d_empty_data_combat, 0.05
  - vfx_player_death, 0,1.5,1, 0,90,90, d_empty_data_combat, 0.1
  - vfx_player_death, 0,1.5,1, 0,90,270, d_empty_data_combat, 0.1
  - vfx_player_death, -0.5,1.5,1, 0,90,90, d_empty_data_combat, 0.15
  - vfx_player_death, 0.5,1.5,1, 0,90,270, d_empty_data_combat, 0.15

####################################################
# Atgeirs Impale
# The first primary attack with an atgeir impales the target for bonus dmg based on player momentum.
# Bonus damage scales linearly with atgeir base damage and exponentially with player forward speed at time of attack.
# Filters set such that most loadouts require a player to be sprinting to trigger impale.
# minDistance set to prevent triggers if player right up against a mob.  Must be far enough to hit with the blade instead of the shaft.
# Atgeir base dmg per tier (tiers 2-8):  39, 56, 76, 93, 113, 130, 150
#################
# Atgeir Tier 2
- prefab: Player
  type: state, atgeir_attack0
  filter: gear_atgeir_t2              ### checks atgeir tier for dmg & checks momentum for sprinting
  data: d_impaling_player_set         ### flag player to align bloodspray in multiplayer
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### keep this equal to delay in p_impale_save_dmg
    parameter: p_impaling_player_rst
  - prefab: creature
    minDistance: 3.5                  ### if sprinting this distance should enforce hitting with blade instead of shaft of atgeir.  also prevents running in place while faceplanted in the mob.
    maxDistance: 9
    data: not_tamed_combat
    parameter: p_impale_save_dmg 39*<float_$forward_speed>*<float_$forward_speed>*0.01+<vImpaleDmgRnd>   ### First constant is base dmg per tier of atgeir.  Divisor normalizes squared momentum to get a percentage of atgeir base damage.  At +14% movespeed full sprint max sqrd momentum = 65.  At -15% movespeed full sprint max sqrd momentum = 33.

# Atgeir Tier 3
- prefab: Player
  type: state, atgeir_attack0
  filter: gear_atgeir_t3              ### checks atgeir tier for dmg & checks momentum for sprinting
  data: d_impaling_player_set         ### flag player to align bloodspray in multiplayer
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### keep this equal to delay in p_impale_save_dmg
    parameter: p_impaling_player_rst
  - prefab: creature
    minDistance: 3.5                  ### if sprinting this distance should enforce hitting with blade instead of shaft of atgeir.
    maxDistance: 9
    data: not_tamed_combat
    parameter: p_impale_save_dmg 56*<float_$forward_speed>*<float_$forward_speed>*0.01+<vImpaleDmgRnd>   ### First constant is base dmg per tier of atgeir.  Divisor normalizes squared momentum to get a percentage of atgeir base damage.  At +14% movespeed full sprint max sqrd momentum = 65.  At -15% movespeed full sprint max sqrd momentum = 33.

# Atgeir Tier 4
- prefab: Player
  type: state, atgeir_attack0
  filter: gear_atgeir_t4              ### checks atgeir tier for dmg & checks momentum for sprinting
  data: d_impaling_player_set         ### flag player to align bloodspray in multiplayer
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### keep this equal to delay in p_impale_save_dmg
    parameter: p_impaling_player_rst
  - prefab: creature
    minDistance: 3.5                  ### if sprinting this distance should enforce hitting with blade instead of shaft of atgeir.
    maxDistance: 9
    data: not_tamed_combat
    parameter: p_impale_save_dmg 76*<float_$forward_speed>*<float_$forward_speed>*0.01+<vImpaleDmgRnd>   ### First constant is base dmg per tier of atgeir.  Divisor normalizes squared momentum to get a percentage of atgeir base damage.  At +14% movespeed full sprint max sqrd momentum = 65.  At -15% movespeed full sprint max sqrd momentum = 33.

# Atgeir Tier 5
- prefab: Player
  type: state, atgeir_attack0
  filter: gear_atgeir_t5              ### checks atgeir tier for dmg & checks momentum for sprinting
  data: d_impaling_player_set         ### flag player to align bloodspray in multiplayer
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### keep this equal to delay in p_impale_save_dmg
    parameter: p_impaling_player_rst
  - prefab: creature
    minDistance: 3.5                  ### if sprinting this distance should enforce hitting with blade instead of shaft of atgeir.
    maxDistance: 9
    data: not_tamed_combat
    parameter: p_impale_save_dmg 93*<float_$forward_speed>*<float_$forward_speed>*0.01+<vImpaleDmgRnd>   ### First constant is base dmg per tier of atgeir.  Divisor normalizes squared momentum to get a percentage of atgeir base damage.  At +14% movespeed full sprint max sqrd momentum = 65.  At -15% movespeed full sprint max sqrd momentum = 33.

# Atgeir Tier 6
- prefab: Player
  type: state, atgeir_attack0
  filter: gear_atgeir_t6              ### checks atgeir tier for dmg & checks momentum for sprinting
  data: d_impaling_player_set         ### flag player to align bloodspray in multiplayer
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### keep this equal to delay in p_impale_save_dmg
    parameter: p_impaling_player_rst
  - prefab: creature
    minDistance: 3.5                  ### if sprinting this distance should enforce hitting with blade instead of shaft of atgeir.
    maxDistance: 9
    data: not_tamed_combat
    parameter: p_impale_save_dmg 113*<float_$forward_speed>*<float_$forward_speed>*0.01+<vImpaleDmgRnd>   ### First constant is base dmg per tier of atgeir.  Divisor normalizes squared momentum to get a percentage of atgeir base damage.  At +14% movespeed full sprint max sqrd momentum = 65.  At -15% movespeed full sprint max sqrd momentum = 33.

# Atgeir Tier 7
- prefab: Player
  type: state, atgeir_attack0
  filter: gear_atgeir_t7              ### checks atgeir tier for dmg & checks momentum for sprinting
  data: d_impaling_player_set         ### flag player to align bloodspray in multiplayer
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### keep this equal to delay in p_impale_save_dmg
    parameter: p_impaling_player_rst
  - prefab: creature
    minDistance: 3.5                  ### if sprinting this distance should enforce hitting with blade instead of shaft of atgeir.
    maxDistance: 9
    data: not_tamed_combat
    parameter: p_impale_save_dmg 130*<float_$forward_speed>*<float_$forward_speed>*0.01+<vImpaleDmgRnd>   ### First constant is base dmg per tier of atgeir.  Divisor normalizes squared momentum to get a percentage of atgeir base damage.  At +14% movespeed full sprint max sqrd momentum = 65.  At -15% movespeed full sprint max sqrd momentum = 33.

# Atgeir Tier 8
- prefab: Player
  type: state, atgeir_attack0
  filter: gear_atgeir_t8              ### checks atgeir tier for dmg & checks momentum for sprinting
  data: d_impaling_player_set         ### flag player to align bloodspray in multiplayer
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### keep this equal to delay in p_impale_save_dmg
    parameter: p_impaling_player_rst
  - prefab: creature
    minDistance: 3.5                  ### if sprinting this distance should enforce hitting with blade instead of shaft of atgeir.
    maxDistance: 9
    data: not_tamed_combat
    parameter: p_impale_save_dmg 150*<float_$forward_speed>*<float_$forward_speed>*0.01+<vImpaleDmgRnd>   ### First constant is base dmg per tier of atgeir.  Divisor normalizes squared momentum to get a percentage of atgeir base damage.  At +14% movespeed full sprint max sqrd momentum = 65.  At -15% movespeed full sprint max sqrd momentum = 33.

#################
# Save damage and flag(s) to nearby creatures.  Only the one hit will trigger.
- prefab: creature
  type: poke, p_impale_save_dmg
  data: d_impale_save_dmg             ### save impale dmg to creature & save valid flag that lasts long enough for hit to land
  injectData: true
  poke:
  - self: true
    delay: 0.5                        ### time between start of attack and attack landing.  0.35 min.  0.85 max
    parameter: p_impale_disable

- prefab: creature
  type: poke, p_impale_disable
  data: d_impale_disable              ### disable valid flag to prevent atgeir_attack1 from triggering
  injectData: true

#################
# Check for hit connecting with creature
- prefab: sfx_spear_hit
  type: create
  objects:
  - sfx_sword_hit, 1
  poke:
  - prefab: creature
    maxDistance: 9
    limit: 1
    parameter: p_impale_apply_dmg

#################
# Do damage!  And FX!
- prefab: creature
  type: poke, p_impale_apply_dmg
  filter: d_impale_vld                ### check that creature has a valid impale window flag
  spawns:
  - sfx_troll_attack_hit
  - sfx_troll_hit
  objectRpc:
  - name: RPC_Damage
    1: hit, pierce=<float_f_impale_dmg>
  poke:
  - prefab: Player
    limit: 1
    data: d_impaling_player_set
    parameter: p_impale_blood_vfx

- prefab: Player
  type: poke, p_impale_blood_vfx      ### spray blood in direction of impale
  spawns:
  - vfx_player_death, 0,4,1, 0,90,340

- prefab: Player
  type: poke, p_impaling_player_rst
  data: d_impaling_player_rst
  injectData: true

####################################################
# Heal spells do PBAOE Spirit damage
# BMR_HealScroll1_AOE
- prefab: BMR_HealScroll1_AOE
  type: create
  poke:
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 4
    delay: 0.4
    parameter: p_heal_spell_spiritAE <randi_5_7>

- prefab: BMR_HealScroll2_AOE
  type: create
  poke:
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 4
    delay: 0.4
    parameter: p_heal_spell_spiritAE <randi_17_19>

- prefab: BMR_HealScroll3_AOE
  type: create
  poke:
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 4
    delay: 0.4
    parameter: p_heal_spell_spiritAE <randi_28_32>

- prefab: BMR_HealScroll4_AOE
  type: create
  poke:
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 4
    delay: 0.4
    parameter: p_heal_spell_spiritAE <randi_40_44>

- prefab: BMR_HealScroll5_AOE
  type: create
  poke:
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 4
    delay: 0.4
    parameter: p_heal_spell_spiritAE <randi_51_57>

- prefab: BMR_HealScroll6_AOE
  type: create
  poke:
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 4
    delay: 0.4
    parameter: p_heal_spell_spiritAE <randi_63_69>

# Heal spell spirit AE
- prefab: creature
  type: poke, p_heal_spell_spiritAE
  objectRpc:
  - name: RPC_Damage
    1: hit, spirit=<par1>

####################################################
# Vortex arrows (purple crystal arrows)
# if hitting terrain
- prefab: sfx_jc_arrow_hit
  type: create
  objects:
  - JC_Projectile_Purple, 1
  bannedObjects:
  - fx_shaman_fireball_expl, 1
  - fx_guardstone_deactivate, 1
  bannedObjectsLimit: 2
  spawns:
  - fx_shaman_fireball_expl
  - fx_guardstone_deactivate
  poke:
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 6
    delay: 0.4
    parameter: p_vortex_arrow_pull_calc <x> <z> <randi_6_9> 160  # x | y | dmg | force

# if hitting creature
- prefab: JC_Projectile_Purple
  type: destroy
  bannedObjects:
  - fx_shaman_fireball_expl, 1
  - fx_guardstone_deactivate, 1
  bannedObjectsLimit: 2
  spawns:
  - fx_shaman_fireball_expl
  - fx_guardstone_deactivate
  poke:
  - prefab: creature
    data: not_tamed_combat
    minDistance: 1.5   # far enough from center of impact for pull to work in correct direction
    maxDistance: 6
    parameter: p_vortex_arrow_pull_calc <x> <z> <randi_6_9> 170
  - prefab: creature
    data: not_tamed_combat
    maxDistance: 1.49  # too close to center of impact for pull to work in correct direction - slow only
    parameter: p_vortex_arrow_pull_calc <x> <z> <randi_6_9> 0

# no-op for enemies immune to vortex
- prefab: Eikthyr, gd_king, Bonemass, Dragon, GoblinKing, SeekerQueen, Fader, Troll, Abomination, Serpent, StoneGolem, GoblinBrute, GoblinBruteBros, GoblinBrute_Hildir, SeekerBrute, Gjall, BonemawSerpent, Morgen, Troll_Summoned
  type: poke, p_vortex_arrow_pull_calc
  weight: 1E30

- prefab: creature
  type: poke, p_vortex_arrow_pull_calc
  data: d_force_toward_calc_combat
  injectData: true
  poke:
  - self: true
    delay: 0.1
    parameter: p_vortex_arrow_pull_dmg <par3> <par4>    # dmg | force

- prefab: creature
  type: poke, p_vortex_arrow_pull_dmg
  objectRpc:
  - name: RPC_Damage
    1: hit, pierce=<par1> status=SE_Savheim_Hamstring_Vortex_Arrow force=<par2> dir=<float_f_force_x>,<float_f_force_z>,<y>
