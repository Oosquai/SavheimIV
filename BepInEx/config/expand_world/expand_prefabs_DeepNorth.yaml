########################################################################
# Savheim Deep North - prefabs
# REQUIRES - expand_prefabs_Creatures
########################################################################
# Killing a deer in Deep North starts the Roguelite minigame.
# Mobs get spawned in Waves at regular intervals.
# Killing mobs has a percent chance to increment Subtier.
# Subtier = 7 increases Tier if conditions are satisfied (enough bosses killed).
# Mobs get harder per tier.  Mini-bosses and bosses spawn at specific tiers.
# Get to Tier 8 and clear all mobs to win!  Get loot from mini-bosses and bosses along the way.
# Die or leave to clear status.  Mobs despawn if no flagged players nearby.
# Normal loot tables removed.
# Multiplayer spawns more trash, but with limits.  You can intentionally overpower this event by bringing enough players.
# If using CLLC, more players will also cause mobs to have more health and do more damage.
# Loot quantities are fixed though, so bringing more players means sharing!
#
# TIER | SPAWNS (* indicates must kill boss before passing.  i.e. must kill Elder/Bonemass before you can advance to tier 3.)
#    0 | chance of eikthyr
#    1 | elder or bonemass
#  * 2 | chance of brenna (if too slow killing previous boss!)
#    3 | dragon or yag
#  * 4 | chance of Geirrhafa (if too slow killing previous boss!)
#  * 5 | queen or fader
#    6 | elder, bonemass, or dragon
#    7 | yagluth, queen, or fader (tiers 6 & 7 = two bosses at once!)
#    8 | Victory once all mobs cleared
#    9 | max tier, spawns stop, victory condition still valid

####################################
# Don't murder the deer!
# If no other dnrl-flagged deer nearby already, spawn a persistent, dnrl-flagged ragdoll for this event, and start the event!
- prefab: deer_ragdoll
  type: create
  biomes: DeepNorth
  objects:
  - Player, 100, d_player_roguelite_off
  bannedObjects:
  - deer_ragdoll, 100, dn_deer_ragdoll
  weight: 1E30
  remove: true
  poke:
  - prefab: Player
    data: d_player_roguelite_off
    maxDistance: 100
    limit: 1          # only 1 player gets dead deer at their feet.
    delay: 2
    parameter: p_deer_murder_spawn_ragdoll

# Only 1 player executing this process
- prefab: Player
  type: poke, p_deer_murder_spawn_ragdoll
  biomes: DeepNorth
  spawns:
  - vfx_spawn_small, 0,3,2
  - deer_ragdoll, 0,3,2, dn_deer_ragdoll, false
  - sfx_reaper_idle
  - stone_marker_savheim_dn, 0,3,-3
  command: wait 3000;broadcast center <#00AFAF><string_playerName> has slain an innocent deer in the tranquil Deep North.
  poke:
  - prefab: Player     # poke all nearby players as accomplices, including self
    data: d_player_roguelite_off
    maxDistance: 100
    delay: 3
    parameter: p_deer_murder
  - prefab: deer_ragdoll     # start deer_ragdoll cleanup loop from here so only poked once
    data: dn_deer_ragdoll
    maxDistance: 5
    limit: 1
    delay: 3
    parameter: p_dnrl_cleanup_deer_ragdoll_loop
  - prefab: deer_ragdoll
    data: dn_deer_ragdoll
    maxDistance: 5
    limit: 1
    delay: 10
    parameter: p_dnrl_deer_ragdoll_fx_loop
  - prefab: stone_marker_savheim_dn
    maxDistance: 5
    limit: 1
    delay: 8
    parameter: p_dnrl_weather

- prefab: deer_ragdoll
  type: poke, p_dnrl_deer_ragdoll_fx_loop
  poke:
  - self: true
    delay: 20
    parameter: p_dnrl_deer_ragdoll_fx_loop
  - self: true
    parameter: p_dnrl_deer_ragdoll_fx

- prefab: deer_ragdoll
  type: poke, p_dnrl_deer_ragdoll_fx
  spawn: vfx_MeadBzerker, 0,0,-1.5

- prefab: stone_marker_savheim_dn
  type: poke, p_dnrl_weather
  data: d_dnrl_weather_ashlands_seastorm

####################################
# ... you (or your friend) murdered the deer.  :(
- prefab: Player
  type: poke, p_deer_murder
  biomes: DeepNorth                # only in Deep North
  filter: d_player_roguelite_off   # only process if not already started
  data: d_player_roguelite_start   # clear all state for a fresh start
  injectData: true
  spawns:
  - sfx_ghost_idle, 0,0,0, 0,0,0, d_empty_data_dn, 0
  - sfx_gdking_idle, 0,0,0, 0,0,0, d_empty_data_dn, 3
  - sfx_gdking_scream, 0,0,0, 0,0,0, d_empty_data_dn, 6.5
  - sfx_dragon_scream, 0,0,0, 0,0,0, d_empty_data_dn, 6.5
  objectRpc:
  - name: Message
    1: enum_message, 2
    2: string, <#007F7F>The land stirs, angry and vengeful ...
    3: int, 0
    delay: 3
  - name: Message
    1: enum_message, 2
    2: string, <#7F1F1F>Blood for blood, a life is forfeit!
    3: int, 0
    delay: 6.5
  poke:  
  - self: true               # initial entry into spawner loop
    delay: <randi_12_16>     # randomized startup delay so different players have uniquely timed spawn loops
    parameter: dn_roguelite_spawn <dnTrashMobsT0> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>
  - self: true               # start player cleanup loop
    delay: 1                 # wait for data
    parameter: p_dnrl_cleanup_player_loop

########################################################################
####################################
# MAIN LOOP - self-looping trash mob spawner
- prefab: Player
  type: poke, dn_roguelite_spawn
  biomes: DeepNorth                     # only process if in Deep North
  filters:
  - int, i_player_roguelite_on, 1       # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 0;8   # Spawns stop after tier 9.  Must reach tier 8 and clear all mobs to win.
  data: d_player_roguelite_wave_inc     # increment wave counter
  injectData: true
### DEBUG #########
#  command: s Wave <int_i_player_roguelite_wave> Kills <int_i_player_roguelite_kills> BKills <int_i_player_roguelite_boss_kills> STier <int_i_player_roguelite_subtier> Tier <int_i_player_roguelite_tier> BSpawns <int_i_player_roguelite_boss_spawns>
###################
  poke:
  - self: true                                   # separate process for spawns to check max creatures
    parameter: dn_roguelite_spawn_trash_calc <par1> <par2> <par3> <par4>
  - prefab: Player                               # self-looping spawners!
    maxDistance: 1                               # cannot use self: true, else data not checked
    limit: 1
    delay: <randi_20_25>                         ### LOOP TIMER
    data: d_player_roguelite_tier_0              # Player is at Roguelite tier X --> Choose mob set.
    parameter: dn_roguelite_spawn <dnTrashMobsT0> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_25_30>                         ### LOOP TIMER
    data: d_player_roguelite_tier_1
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_30_35>                         ### LOOP TIMER
    data: d_player_roguelite_tier_2
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_35_40>                         ### LOOP TIMER
    data: d_player_roguelite_tier_3
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT2> <dnTrashMobsT3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_40_45>                         ### LOOP TIMER
    data: d_player_roguelite_tier_4
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT2> <dnTrashMobsT3> <dnTrashMobsT4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_45_50>                         ### LOOP TIMER
    data: d_player_roguelite_tier_5
    parameter: dn_roguelite_spawn <dnTrashMobsT5> <dnTrashMobsT2> <dnTrashMobsT3> <dnTrashMobsT4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_50_55>                         ### LOOP TIMER
    data: d_player_roguelite_tier_6
    parameter: dn_roguelite_spawn <dnTrashMobsT5> <dnTrashMobsT5v2> <dnTrashMobsT3> <dnTrashMobsT4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_55_60>                         ### LOOP TIMER
    data: d_player_roguelite_tier_7
    parameter: dn_roguelite_spawn <dnTrashMobsT5> <dnTrashMobsT5v2> <dnTrashMobsT5v3> <dnTrashMobsT4v2>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: <randi_60_65>                         ### LOOP TIMER
    data: d_player_roguelite_tier_8
    parameter: dn_roguelite_spawn <dnTrashMobsT5> <dnTrashMobsT5v2> <dnTrashMobsT5v3> <dnTrashMobsT4v2>

# check number of nearby players to determine max trash mobs.  ignore whether dnrl flagged, to suppress cheesing.
# 1 player
- prefab: Player
  type: poke, dn_roguelite_spawn_trash_calc
  objects:
  - Player, 100
  objectsLimit: 0            # seems to not count self when poking player!
  bannedObjects:
  - Player, 100
  bannedObjectsLimit: 1
  poke:
  - self: true
    parameter: dn_roguelite_spawn_trash_1p <par1> <par2> <par3> <par4>

# 2 players
- prefab: Player
  type: poke, dn_roguelite_spawn_trash_calc
  objects:
  - Player, 100
  objectsLimit: 1
  bannedObjects:
  - Player, 100
  bannedObjectsLimit: 2
  poke:
  - self: true
    parameter: dn_roguelite_spawn_trash_2p <par1> <par2> <par3> <par4>

# 3 players
- prefab: Player
  type: poke, dn_roguelite_spawn_trash_calc
  objects:
  - Player, 100
  objectsLimit: 2
  bannedObjects:
  - Player, 100
  bannedObjectsLimit: 3
  poke:
  - self: true
    parameter: dn_roguelite_spawn_trash_3p <par1> <par2> <par3> <par4>

# 4+ players
- prefab: Player
  type: poke, dn_roguelite_spawn_trash_calc
  objects:
  - Player, 100
  objectsLimit: 3
  poke:
  - self: true
    parameter: dn_roguelite_spawn_trash_4p <par1> <par2> <par3> <par4>

# spawn trash, capped per players nearby
- prefab: Player
  type: poke, dn_roguelite_spawn_trash_1p
  biomes: DeepNorth
  bannedObjects:
  - creature, 100, dn_mob_group_roguelite
  bannedObjectsLimit: 5                          ### TRASH SPAWN CAP - 1 player
  spawns:
  - <par1>, 12,12,snap, 225,0,0, dn_mob_group_roguelite, 0, true
  - <par2>, 12,-12,snap, 315,0,0, dn_mob_group_roguelite, 0, true
  - <par3>, -12,12,snap, 135,0,0, dn_mob_group_roguelite, 0, true
  - <par4>, -12,-12,snap, 45,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, dn_roguelite_spawn_trash_2p
  biomes: DeepNorth
  bannedObjects:
  - creature, 100, dn_mob_group_roguelite
  bannedObjectsLimit: 9                          ### TRASH SPAWN CAP - 2 players
  spawns:
  - <par1>, 12,12,snap, 225,0,0, dn_mob_group_roguelite, 0, true
  - <par2>, 12,-12,snap, 315,0,0, dn_mob_group_roguelite, 0, true
  - <par3>, -12,12,snap, 135,0,0, dn_mob_group_roguelite, 0, true
  - <par4>, -12,-12,snap, 45,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, dn_roguelite_spawn_trash_3p
  biomes: DeepNorth
  bannedObjects:
  - creature, 100, dn_mob_group_roguelite
  bannedObjectsLimit: 13                         ### TRASH SPAWN CAP - 3 players
  spawns:
  - <par1>, 12,12,snap, 225,0,0, dn_mob_group_roguelite, 0, true
  - <par2>, 12,-12,snap, 315,0,0, dn_mob_group_roguelite, 0, true
  - <par3>, -12,12,snap, 135,0,0, dn_mob_group_roguelite, 0, true
  - <par4>, -12,-12,snap, 45,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, dn_roguelite_spawn_trash_4p
  biomes: DeepNorth
  bannedObjects:
  - creature, 100, dn_mob_group_roguelite
  bannedObjectsLimit: 17                         ### TRASH SPAWN CAP - 4+ players
  spawns:
  - <par1>, 12,12,snap, 225,0,0, dn_mob_group_roguelite, 0, true
  - <par2>, 12,-12,snap, 315,0,0, dn_mob_group_roguelite, 0, true
  - <par3>, -12,12,snap, 135,0,0, dn_mob_group_roguelite, 0, true
  - <par4>, -12,-12,snap, 45,0,0, dn_mob_group_roguelite, 0, true
####################################
########################################################################

####################################
# Limit to one of each boss & miniboss at a time.  Don't spawn GoblinBruteBros, since I'm too lazy to script checking for the shaman to avoid respawning the pair!
# Also limit to one of elites.  This helps balance multiplayer especially, as it creates a cap to spawns per tier, and some RNG since some waves will spawn fewer creatures.
- prefab: Eikthyr, gd_king, Bonemass, Dragon, GoblinKing, SeekerQueen, Fader, Skeleton_Hildir, Fenring_Cultist_Hildir, Troll, Abomination, StoneGolem, GoblinBrute, SeekerBrute, Gjall, FallenValkyrie, Morgen
  type: create
  biomes: DeepNorth
  objects:
  - <prefab>, 100
  weight: 1E30
  remove: true

####################################
# Track mob kills, increase tier variable to control ramping difficulty
# Note, there are versions of this process below in the Loot! section for bosses.
- prefab: creature
  type: destroy
  biomes: DeepNorth
  filter: dn_mob_group_roguelite         # make sure it's a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on   # make sure there's a player nearby with roguelite mode on
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill   # all nearby players poked for kill and subtier checks
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1                             # only nearest player poked to spawn a boss
    delay: 3
    parameter: p_dn_roguelite_boss_check # every kill = check for boss spawn conditions
  - prefab: Player
    data: d_player_roguelite_win_eligible
    maxDistance: 100
    limit: 1                             # only nearest player poked for win check, to avoid multiple Odin / reward spawns
    delay: 1                             # ensure time for mob to no longer register
    parameter: p_dn_roguelite_win_check

# No-op with high weight - these don't count as kills!
- prefab: TentaRoot
  type: destroy
  biomes: DeepNorth
  weight: 1E30
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn

- prefab: Player
  type: poke, p_dn_roguelite_mob_kill
  biomes: DeepNorth                    # only process if in Deep North
  filter: d_player_roguelite_on        # only process if player has started roguelite (by killing deer)
  data: d_player_roguelite_kills_inc   # increment kills counter
  injectData: true
  poke:
  - self: true
    parameter: p_dn_roguelite_subtier_check  # every kill = % chance to advance subtier

- prefab: Player
  type: poke, p_dn_roguelite_boss_kill
  biomes: DeepNorth                        # only process if in Deep North
  filter: d_player_roguelite_on            # only process if player has started roguelite (by killing deer)
  data: d_player_roguelite_boss_kills_inc  # increment boss kills counter
  injectData: true

# Subtiers count toward tier increments, but slightly random because ... RNG is fun!
- prefab: Player
  type: poke, p_dn_roguelite_subtier_check
  biomes: DeepNorth
  filter: d_player_roguelite_on
  weight: 0.85                            # percent chance to increment subtier counter
  data: d_player_roguelite_subtier_inc
  injectData: true
  poke:
  - self: true
    parameter: p_dn_roguelite_tier_check  # if subtier increased, check if ready to advance to next tier

####################################
# Tier checks.  Must kill bosses to get past certain tiers.  Eikthyr doesn't count.
- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1           # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 7;9999 # should trigger at 7, but will go higher if waiting for a boss kill
  - int, i_player_roguelite_boss_kills, 0   # Haven't killed any bosses ...
  - int, i_player_roguelite_tier, 0;1       # ... so max tier is X+1 = 2
  data: d_player_roguelite_tier_inc         # If all requirements met, increment tier counter (also resets subtier counter)
  injectData: true

- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1
  - int, i_player_roguelite_subtier, 7;9999
  - int, i_player_roguelite_boss_kills, 1   # Killed Elder or Bonemass ...
  - int, i_player_roguelite_tier, 1;3       # ... so max tier is X+1 = 4
  data: d_player_roguelite_tier_inc
  injectData: true

- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1
  - int, i_player_roguelite_subtier, 7;9999
  - int, i_player_roguelite_boss_kills, 2   # Killed Moder or Yagluth ...
  - int, i_player_roguelite_tier, 3;4       # ... so max tier is X+1 = 5
  data: d_player_roguelite_tier_inc
  injectData: true

- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1
  - int, i_player_roguelite_subtier, 7;9999
  - int, i_player_roguelite_boss_kills, 3   # Killed Queen or Fader ...
  - int, i_player_roguelite_tier, 4;7       # ... so max tier is X+1 = 8
  data: d_player_roguelite_tier_inc
  injectData: true

- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1
  - int, i_player_roguelite_subtier, 7;9999
  - int, i_player_roguelite_boss_kills, 4;999  # Killed one additional boss (likely one other still up) ...
  - int, i_player_roguelite_tier, 6;999        # ... so max tier is unlocked
  data: d_player_roguelite_tier_inc
  injectData: true

########################################################################
# Boss and mini-boss spawners
### Tier 0 - Eikthyr
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 0.25                                 # % chance per kill to spawn
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 0            # check tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_eikthyr_spawn, 0   # check that one hasn't spawned yet for this tier
  data: d_player_roguelite_eikthyr_spawn       # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Eikthyr, 0,12,snap, 180,0,0, dn_mob_group_roguelite_eikthyr, 0, true

### Tier 1 - Elder or Bonemass
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 1;2          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 0     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - gd_king, 0,12,snap, 180,0,0, dn_mob_group_roguelite_elder, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 1;2          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 0     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Bonemass, 0,12,snap, 180,0,0, dn_mob_group_roguelite_bonemass, 0, true

### Tier 2 - Brenna
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 0.1                                  # % chance per kill to spawn
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 2            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_brenna_spawn, 0    # check that one hasn't spawned yet for this tier
  data: d_player_roguelite_brenna_spawn        # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Skeleton_Hildir, 0,12,snap, 180,0,0, dn_mob_group_roguelite_brenna, 0, true

### Tier 3 - Moder or Yagluth
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 3;4          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 1     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Dragon, 0,12,snap, 180,0,0, dn_mob_group_roguelite_moder, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 3;4          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 1     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - GoblinKing, 0,12,snap, 180,0,0, dn_mob_group_roguelite_yagluth, 0, true

### Tier 4 - Geirrhafa
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 0.1                                  # % chance per kill to spawn
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 4            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_geirrhafa_spawn, 0 # check that one hasn't spawned yet for this tier
  data: d_player_roguelite_geirrhafa_spawn     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Fenring_Cultist_Hildir, 0,12,snap, 180,0,0, dn_mob_group_roguelite_geirrhafa, 0, true

### Tier 5 - Queen or Fader
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 5            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 2     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - SeekerQueen, 0,12,snap, 180,0,0, dn_mob_group_roguelite_queen, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;9999    # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 5            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 2     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Fader, 0,12,snap, 180,0,0, dn_mob_group_roguelite_fader, 0, true

### Tier 6 - Elder, Bonemass, or Moder
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 6            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 3     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - gd_king, 0,12,snap, 180,0,0, dn_mob_group_roguelite_elder, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 6            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 3     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Bonemass, 0,12,snap, 180,0,0, dn_mob_group_roguelite_bonemass, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 6            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 3     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Dragon, 0,12,snap, 180,0,0, dn_mob_group_roguelite_moder, 0, true

### Tier 7 - Yagluth, Queen, or Fader
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 7            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 4     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - GoblinKing, 0,12,snap, 180,0,0, dn_mob_group_roguelite_yagluth, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 7            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 4     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - SeekerQueen, 0,12,snap, 180,0,0, dn_mob_group_roguelite_queen, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 7            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 4     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Fader, 0,12,snap, 180,0,0, dn_mob_group_roguelite_fader, 0, true

########################################################################
# Loot!
# Raaka's trick for removing loot, used here with mobs spawned by roguelite - thanks, Raaka!
# Any itemdrop created above 9000 altitude is instantly removed.    
- prefab: ItemDrop
  type: create
  biomes: DeepNorth
  minY: 9000
  remove: true

# The altitude trick doesn't help with creatures who leave ragdolls though, so another Raaka trick!
# Swap ragdolls, causing them to abandon their loot tables
# Need special processes to duplicate behavior of unique battleaxe, for roguelite ON and OFF.
### Battleaxe, roguelite OFF
- prefab: Ragdoll
  type: create
  biomes: DeepNorth
  objects:
  - Player, 6, d_purple_battleaxe
  - vfx_wraith_hit, 6
  bannedObjects:
  - Player, 100, d_player_roguelite_on
  spawns:
  - fx_goblinking_beam_hit, 0,0,1, 0,0,0, d_empty_data_dn, 0.3
  - vfx_puff_small, 0,0,1, 0,0,0, d_empty_data_dn, 0.3
  - sfx_wraith_alerted, 0,0,0, 0,0,0, purple_axe_low_pitch, 0
  poke:
  - prefab: creature
    maxDistance: 12
    data: not_tamed_dn
    parameter: p_soulcleave_randomDelay

### Battleaxe, roguelite ON
- prefab: Ragdoll
  type: create
  biomes: DeepNorth
  objects:
  - Player, 100, d_player_roguelite_on
  - Player, 6, d_purple_battleaxe
  - vfx_wraith_hit, 6
  weight: 1E30      # ensure always triggers vs. no battleaxe version below
  spawns:
  - fx_goblinking_beam_hit, 0,0,1, 0,0,0, d_empty_data_dn, 0.3
  - vfx_puff_small, 0,0,1, 0,0,0, d_empty_data_dn, 0.3
  - sfx_wraith_alerted, 0,0,0, 0,0,0, purple_axe_low_pitch, 0
  poke:
  - prefab: creature
    maxDistance: 12
    data: not_tamed_dn
    parameter: p_soulcleave_randomDelay
  remove: true
  spawn:
  - prefab: <prefab>
    triggerRules: false

### No battleaxe, roguelite ON (no further action needed for neither battleaxe nor roguelite)
- prefab: Ragdoll
  type: create
  biomes: DeepNorth
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  remove: true
  spawn:
  - prefab: <prefab>
    triggerRules: false

# Also reduce clutter by removing Enchanting loot
- prefab: kg_EnchantSkillScroll_F, kg_EnchantSkillScroll_D, kg_EnchantSkillScroll_C, kg_EnchantSkillScroll_B, kg_EnchantSkillScroll_A, kg_EnchantSkillScroll_S, kg_EnchantScroll_Weapon_Blessed_F, kg_EnchantScroll_Weapon_Blessed_D, kg_EnchantScroll_Weapon_Blessed_C, kg_EnchantScroll_Weapon_Blessed_B, kg_EnchantScroll_Weapon_Blessed_A, kg_EnchantScroll_Weapon_Blessed_S, kg_EnchantScroll_Weapon_F, kg_EnchantScroll_Weapon_D, kg_EnchantScroll_Weapon_C, kg_EnchantScroll_Weapon_B, kg_EnchantScroll_Weapon_A, kg_EnchantScroll_Weapon_S, kg_EnchantScroll_Armor_Blessed_F, kg_EnchantScroll_Armor_Blessed_D, kg_EnchantScroll_Armor_Blessed_C, kg_EnchantScroll_Armor_Blessed_B, kg_EnchantScroll_Armor_Blessed_A, kg_EnchantScroll_Armor_Blessed_S, kg_EnchantScroll_Armor_F, kg_EnchantScroll_Armor_D, kg_EnchantScroll_Armor_C, kg_EnchantScroll_Armor_B, kg_EnchantScroll_Armor_A, kg_EnchantScroll_Armor_S
  type: create
  biomes: DeepNorth
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  remove: true

# If a boss was killed, special counter incremented in addition to everything else, plus loot!
# Note, we're treating Eikthyr as trash, but he still has a loot table.  He only has a random chance to spawn.
- prefab: Eikthyr
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (Eikthyr only counts as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 11                              # timed relative to ragdoll despawn timing
    parameter: p_boss_loot_dn_roguelite_no_coin <bossDropsEikthyrDnRoguelite>

- prefab: gd_king
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 12
    parameter: p_boss_loot_dn_roguelite <bossDropsElderDnRoguelite>

- prefab: Bonemass
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 5
    parameter: p_boss_loot_dn_roguelite <bossDropsBonemassDnRoguelite>

- prefab: Dragon
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 8
    parameter: p_boss_loot_dn_roguelite <bossDropsDragonDnRoguelite>

- prefab: GoblinKing
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 10
    parameter: p_boss_loot_dn_roguelite <bossDropsYagluthDnRoguelite>

- prefab: SeekerQueen
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 6
    parameter: p_boss_loot_dn_roguelite <bossDropsQueenDnRoguelite>

- prefab: Fader
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 14
    parameter: p_boss_loot_dn_roguelite <bossDropsFaderDnRoguelite>

# Mini-bosses
- prefab: Skeleton_Hildir
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (mini-bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 3
    parameter: p_boss_loot_dn_roguelite_no_coin <bossDropsBrennaDnRoguelite>

# Mini-bosses
- prefab: Fenring_Cultist_Hildir
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 100, d_player_roguelite_on     # must be a nearby player with roguelite active
  spawns:
  - sfx_gui_craftitem_cauldron, 0,0,0, 0,0,0, d_sfx_silent_dn
  - sfx_build_table, 0,0,0, 0,0,0, d_sfx_silent_dn
  poke:
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (mini-bosses count as a kill)
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    limit: 1
    delay: 3
    parameter: p_boss_loot_dn_roguelite_no_coin <bossDropsGeirrhafaDnRoguelite>

# Boss Loot.  No coins from Eikthyr or mini-bosses.
- prefab: Player
  type: poke, p_boss_loot_dn_roguelite_no_coin
  biomes: DeepNorth                         # only process if in Deep North
  filters:
  - int, i_player_roguelite_on, 1           # roguelite mode must be active for player
  spawns:
  - <par1>, 0,0,snap, 0,0,0, d_empty_data_dn, 0
  - fx_chainlightning_hit, 0,0,snap, 0,0,0, d_empty_data_dn, 0
  - fx_HildirChest_Unlock, 0,0,snap, 0,0,0, d_sfx_silent_dn, 0
  - fx_lightningweapon_hit, 0,0,snap, 0,0,0, d_empty_data_dn, 0.2
  - fx_DvergerMage_Mistile_die, 0,0,snap, 0,0,0, d_empty_data_dn, 0.2
  - vfx_coin_pile_destroyed, 0,0,snap, 0,0,0, d_empty_data_dn, 0.35
  - sfx_coins_destroyed, 0,0,snap, 0,0,0, d_empty_data_dn, 0.35

- prefab: Player
  type: poke, p_boss_loot_dn_roguelite
  biomes: DeepNorth                         # only process if in Deep North
  filters:
  - int, i_player_roguelite_on, 1           # roguelite mode must be active for player
  spawns:
  - <par1>, 0,0,snap, 0,0,0, d_empty_data_dn, 0
  - JC_Gacha_Coins, 0,0,snap, 0,0,0, d_empty_data_dn, 0
  - fx_chainlightning_hit, 0,0,snap, 0,0,0, d_empty_data_dn, 0
  - fx_HildirChest_Unlock, 0,0,snap, 0,0,0, d_sfx_silent_dn, 0
  - fx_lightningweapon_hit, 0,0,snap, 0,0,0, d_empty_data_dn, 0.2
  - fx_DvergerMage_Mistile_die, 0,0,snap, 0,0,0, d_empty_data_dn, 0.2
  - vfx_coin_pile_destroyed, 0,0,snap, 0,0,0, d_empty_data_dn, 0.35
  - sfx_coins_destroyed, 0,0,snap, 0,0,0, d_empty_data_dn, 0.35

########################################################################
# Roguelite Win Conditions
# Must have made it to tier 8 and cleared all nearby roguelite mobs
- prefab: Player
  type: poke, p_dn_roguelite_win_check
  biomes: DeepNorth                         # only process if in Deep North
  filters:
  - int, i_player_roguelite_on, 1           # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 8;9999    # Player must be at least tier 8
  - int, i_player_roguelite_win, 0          # prevent multiple win triggers if mobs killed simultaneously
  bannedObjects:
  - creature, 100, dn_mob_group_roguelite   # no nearby creatures tagged as roguelite mob
  poke:
  - self: true
    delay: 15
    parameter: p_dn_roguelite_win_sequence <rogueliteLoot>  # You win!
  - prefab: Player
    data: d_player_roguelite_on
    maxDistance: 100
    parameter: p_player_roguelite_win_set

# tag all players as having won to prevent multiple win conditions
- prefab: Player
  type: poke, p_player_roguelite_win_set
  data: d_player_roguelite_win_set
  injectData: true

- prefab: Player
  type: poke, p_dn_roguelite_win_sequence
  biomes: DeepNorth                         # only process if in Deep North
  command: broadcast center <#00AFAF>Odin honors Deep North champion <string_playerName>!  They conquered <int_i_player_roguelite_wave> waves and killed <int_i_player_roguelite_kills> creatures.
  data: d_player_roguelite_clear
  injectData: true
  spawns:
  - Odin, 0,8,snap, 180,0,0, d_odin_persist, 0
  - sfx_haldor_yea, 0,8,snap, d_sfx_odin_greet_pitch_dn, 1
  - sfx_haldor_laugh, 0,8,snap, d_sfx_odin_greet_pitch_dn, 3
  - vfx_FireWork_BlackCore, 0,12,2 0,0,0, d_empty_data_dn, 3.2
  - vfx_Firework_Rocket_Red, 12,11,-4 0,0,0, d_empty_data_dn, 3.8
  - sfx_firework_explode, 12,11,-4 0,0,0, d_empty_data_dn, 3.8
  - vfx_Firework_Rocket_Yellow, -23,12,snap 0,0,0, d_empty_data_dn, 4.2
  - sfx_firework_explode, -23,12,snap 0,0,0, d_empty_data_dn, 4.2
  - vfx_Firework_Rocket_Cyan, 1,6,12 0,0,0, d_empty_data_dn, 4.7
  - sfx_firework_explode, 1,6,12 0,0,0, d_empty_data_dn, 4.7
  - vfx_Firework_Rocket_Purple, -13,15,-9 0,0,0, d_empty_data_dn, 5.1
  - sfx_firework_explode, -13,15,-9 0,0,0, d_empty_data_dn, 5.1
  - vfx_Firework_Rocket_Green, 17,17,snap 0,0,0, d_empty_data_dn, 5.4
  - sfx_firework_explode, 17,17,snap 0,0,0, d_empty_data_dn, 5.4
  - fx_HildirChest_Unlock, 0,6,snap, 0,0,0, d_sfx_silent_dn, 16
  - fx_chainlightning_hit, 0,6,snap, 0,0,0, d_empty_data_dn, 16
  - fx_lightningweapon_hit, 0,6,snap, 0,0,0, d_empty_data_dn, 16.2
  - fx_DvergerMage_Mistile_die, 0,6,snap, 0,0,0, d_empty_data_dn, 16.2
  - vfx_coin_pile_destroyed, 0,6,snap, 0,0,0, d_empty_data_dn, 16.35
  - sfx_coins_destroyed, 0,6,snap, 0,0,0, d_empty_data_dn, 16.35
  - <par1>, 0,6,snap, 0,0,0, d_empty_data_dn, 16
  - MoltenCore, 0,6,snap, 0,0,0, d_empty_data_dn, 16
  - sfx_haldor_greet, 0,8,snap, d_sfx_odin_greet_pitch_dn, 19
  poke:
  - prefab: Odin              # Odin prevented from leaving during reward sequence
    delay: 16.3               # injectData doesn't seem to work for this, so hide his flicker in other effects
    maxDistance: 50
    parameter: p_odin_closer  # let him leave once it concludes
  - prefab: deer_ragdoll
    data: dn_deer_ragdoll
    maxDistance: 100
    delay: 1
    parameter: p_dnrl_victory_remove_deer_ragdoll
  - prefab: creature
    maxDistance: 150                    # wider range in case Fallen Valkyrie flew away at the perfect time
    parameter: p_dnrl_remove_creature
  - prefab: stone_marker_savheim_dn
    maxDistance: 100
    parameter: p_dnrl_remove_items

- prefab: Odin
  type: poke, p_odin_closer
  data: d_odin_closer

- prefab: deer_ragdoll
  type: poke, p_dnrl_victory_remove_deer_ragdoll
  spawn: vfx_corpse_destruction_small
  remove: true

########################################################################
# Clean up player state and mobs, broadcast failure results
####################################
# Player main cleanup loop - do not check biome since want to clear if teleport
- prefab: Player
  type: poke, p_dnrl_cleanup_player_loop
  filter: d_player_roguelite_on  # only process if player has roguelite active
  poke:
  - self: true
    delay: 3
    parameter: p_dnrl_cleanup_player_loop
  - self: true
    parameter: p_dnrl_cleanup_player_fled

# Check if deer_ragdoll still within range, else player fled
- prefab: Player
  type: poke, p_dnrl_cleanup_player_fled
  filters:
  - int, i_player_roguelite_on, 1
  bannedObjects:
  - deer_ragdoll, 100, dn_deer_ragdoll
  data: d_player_roguelite_clear
  injectData: true
  commands:
  - broadcast center <#00AFAF><string_playerName> has fled the Deep North's wrath!  They ran away during wave <int_i_player_roguelite_wave> after killing <int_i_player_roguelite_kills> creatures.
  - s <string_playerName> has fled the Deep North's wrath!  They ran away during wave <int_i_player_roguelite_wave> after killing <int_i_player_roguelite_kills> creatures.

####################################
# Deer ragdoll main cleanup loop
- prefab: deer_ragdoll
  type: poke, p_dnrl_cleanup_deer_ragdoll_loop
  biomes: DeepNorth
  filter: dn_deer_ragdoll        # only process if ragdoll has dnrl flag
  poke:
  - self: true
    delay: 3
    parameter: p_dnrl_cleanup_deer_ragdoll_loop
  - self: true
    parameter: p_dnrl_cleanup_deer_ragdoll_abandoned

# Check if no dnrl-flagged players nearby, then clean up creatures and self
- prefab: deer_ragdoll
  type: poke, p_dnrl_cleanup_deer_ragdoll_abandoned
  biomes: DeepNorth
  bannedObjects:
  - Player, 100, d_player_roguelite_on
  spawn: vfx_corpse_destruction_small
  remove: true
  removeDelay: 3                        # need this to ensure player fled triggers before player failsafe
  poke:
  - prefab: creature
    maxDistance: 150                    # wider range in case people trying to cheese by kiting - mobs will despawn
    parameter: p_dnrl_remove_creature
  - prefab: creature
    maxDistance: 150
    delay: 6                            # do it again for extra spawns - especially twitchers
    parameter: p_dnrl_remove_creature
  - prefab: ItemDrop
    maxDistance: 100
    parameter: p_dnrl_remove_items
  - prefab: stone_marker_savheim_dn
    maxDistance: 100
    parameter: p_dnrl_remove_items

# remove roguelite creatures
- prefab: creature
  type: poke, p_dnrl_remove_creature
  biomes: DeepNorth
  filter: d_creature_roguelite
  poke:
  - self: true
    delay: <randf_0.5_1.5>
    parameter: p_dnrl_remove_random_delay

# remove spawns from roguelite creatures
- prefab: Blob, SeekerBrood, Charred_Twitcher, Tick
  type: poke, p_dnrl_remove_creature
  biomes: DeepNorth
  poke:
  - self: true
    delay: <randf_0.5_1.5>
    parameter: p_dnrl_remove_random_delay

# remove loose items
- prefab: ItemDrop, stone_marker_savheim_dn
  type: poke, p_dnrl_remove_items
  biomes: DeepNorth
  poke:
  - self: true
    delay: <randf_0.5_1.5>
    parameter: p_dnrl_remove_random_delay

- prefab: creature, ItemDrop, stone_marker_savheim_dn
  type: poke, p_dnrl_remove_random_delay
  spawn: vfx_corpse_destruction_small
  remove: true

####################################
# Clear state if player dies and releases.
# Getting resurrected shouldn't trigger this.
# This should trigger before the Player Fled processes above, and this will remove roguelite state to avoid those triggering.
- prefab: Player
  type: destroy
  biomes: DeepNorth
  filter: d_player_roguelite_on
  commands:
  - broadcast center <#00AFAF><string_playerName> was consumed by the Deep North!  They perished during wave <int_i_player_roguelite_wave> after killing <int_i_player_roguelite_kills> creatures.
  - s <string_playerName> was consumed by the Deep North!  They perished during wave <int_i_player_roguelite_wave> after killing <int_i_player_roguelite_kills> creatures.
  data: d_player_roguelite_clear
  injectData: true

# roguelite_remove_failsafe - any player action when not near dnrl-flagged deer_ragdoll clears roguelite state
- prefab: Player
  type: state, *
  filter: d_player_roguelite_on
  bannedObjects:
  - deer_ragdoll, 150, dn_deer_ragdoll   # wider range so this doesn't trigger before normal Player Fled process
  data: d_player_roguelite_clear
  injectData: true
  command: s DEBUG - Deep North roguelite_remove_failsafe - tell Sav!

########################################################################
# Spawn data and specific creature data
####################################
# Spawn data
- prefab: Deer
  type: create
  biomes: DeepNorth
  data: dn_deer

# for creatures spawned by other creatures
- prefab: Blob, SeekerBrood, Charred_Twitcher, Tick
  type: create
  biomes: DeepNorth
  data: dn_mob_group_no_loot

####################################
# Eikthyr Tweaks
# Extra attacks to give Eikthyr damage appropriate for Deep North
- prefab: Eikthyr
  type: state, attack1
  biomes: DeepNorth
  poke:
  - prefab: Player, creature
    delay: 0.7
    maxDistance: 4
    parameter: p_eikthyr_attack1 <dnEikthyrDmgPlayer> <dnEikthyrDmgTame>

- prefab: Eikthyr
  type: state, attack2
  biomes: DeepNorth
  poke:
  - prefab: Player, creature
    delay: 1.6
    maxDistance: 16
    parameter: p_eikthyr_attack2 <dnEikthyrDmgPlayer> <dnEikthyrDmgTame>

- prefab: Eikthyr
  type: state, attack_stomp
  biomes: DeepNorth
  poke:
  - prefab: Player, creature
    delay: 3
    maxDistance: 8
    parameter: p_eikthyr_attack_stomp <dnEikthyrDmgPlayer> <dnEikthyrDmgTame>

- prefab: Player
  type: poke, p_eikthyr_attack1
  objectRpc:
  - name: RPC_Damage
    1: hit, slash=<par1> dodge=true block=true

- prefab: Creature
  type: poke, p_eikthyr_attack1
  filter: tamed_dn
  objectRpc:
  - name: RPC_Damage
    1: hit, slash=<par2> dodge=true block=true

- prefab: Player
  type: poke, p_eikthyr_attack2
  spawn: fx_chainlightning_hit
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par1> dodge=true block=true

- prefab: Creature
  type: poke, p_eikthyr_attack2
  filter: tamed_dn
  spawn: fx_chainlightning_hit
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par2> dodge=true block=true

- prefab: Player
  type: poke, p_eikthyr_attack_stomp
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par1> dodge=true block=true

- prefab: Creature
  type: poke, p_eikthyr_attack_stomp
  filter: tamed_dn
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par2> dodge=true block=true

####################################
# Boss HP adjustments
- prefab: Eikthyr, gd_king, Bonemass, Dragon, GoblinKing, SeekerQueen, Fader, Fenring_Cultist_Hildir
  type: create
  biomes: DeepNorth
  poke:
  - self: true
    delay: 0.1   # need this else they insta-die.  hp not registered yet maybe?
    parameter: p_dn_boss_hp_adjustments

- prefab: Eikthyr
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_eikthyr

- prefab: gd_king
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_elder

- prefab: Bonemass
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_bonemass

- prefab: Dragon
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_moder

- prefab: GoblinKing
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_yagluth

- prefab: SeekerQueen
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_queen

- prefab: Fader
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_fader

- prefab: Skeleton_Hildir
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_brenna

- prefab: Fenring_Cultist_Hildir
  type: poke, p_dn_boss_hp_adjustments
  biomes: DeepNorth
  data: d_dn_boss_hp_geirrhafa

###################################################
# Creature level up chances
- prefab: creature
  type: poke, p_creature_level_up_dn
  bannedFilters:
  - int, CL&LC effect, 5                         # do not create never-ending splitting creatures!
  data: d_creature_level_up_dn

- prefab: creature
  type: create
  biomes: DeepNorth
  fallback: true
  poke:
  - self: true
    parameter: p_creature_level_up_calc_dn

# Low level up chances
- prefab: Troll, Abomination, StoneGolem, GoblinBrute, Lox, BlobTar, Seeker
  type: poke, p_creature_level_up_calc_dn
  biomes: DeepNorth
  poke:
  - self: true
    delay: 0.1
    parameter: p_creature_level_up_dn <vLevelUp1Dn>

# Medium level up chances
- prefab: Skeleton_Poison, Greydwarf_Elite, Greydwarf_Shaman, Wraith, BlobElite, Draugr_Elite, Fenring, Fenring_Cultist, Ulv, Hatchling, Goblin, GoblinShaman
  type: poke, p_creature_level_up_calc_dn
  biomes: DeepNorth
  poke:
  - self: true
    delay: 0.1
    parameter: p_creature_level_up_dn <vLevelUp2Dn>

# High level up chances
- prefab: Ghost, Skeleton, Bat, Surtling
  type: poke, p_creature_level_up_calc_dn
  biomes: DeepNorth
  poke:
  - self: true
    delay: 0.1
    parameter: p_creature_level_up_dn <vLevelUp3Dn>

#####################################################################
# Other Deep North mechanics
#####################################################################
# Sleeping creatures fly again
- prefab: Hatchling
  type: state, wakeup
  biomes: DeepNorth
  data: d_againFlying_dn

#############################################################
# Deep North Treasure Chests
# TreasureChest_charredfortress - rares
# TreasureChest_ashland_stone - weapons
# TreasureChest_plains_stone - consumables
# TreasureChest_plainsfortress_hildir - materials
# TreasureChest_meadows - low quality
## Rares
#- prefab: TreasureChest_charredfortress
#  type: create
#  biomes: DeepNorth
#  weight: 1E30
#  poke:
#  - self: true
#    parameter: p_treasurechest_dn_rares <vExperienceTomes> <vAshlandsGemsAndUpgradeMats> <vAshlandsGemsAndUpgradeMats> <vWeaponsT7> <vDnRareMaterials>
#
#- prefab: TreasureChest_charredfortress
#  type: poke, p_treasurechest_dn_rares
#  data: d_treasurechest_dn_rares
#  injectData: true

# Weapons
- prefab: TreasureChest_ashland_stone
  type: create
  biomes: DeepNorth
  weight: 1E30
  poke:
  - self: true
    parameter: p_treasurechest_dn_weapons <vExperienceTomes> <vAshlandsGemsAndUpgradeMats> <vAshlandsGemsAndUpgradeMats> <vWeaponsT7> <vPreciousStones> <vDnRareMaterials>

- prefab: TreasureChest_ashland_stone
  type: poke, p_treasurechest_dn_weapons
  data: d_treasurechest_dn_weapons
  injectData: true

# Consumables
- prefab: TreasureChest_plains_stone
  type: create
  biomes: DeepNorth
  weight: 1E30
  poke:
  - self: true
    parameter: p_treasurechest_dn_consumables <vDnRegenConsumables> <vDnBuffConsumables> <vDnFoodConsumables> <vDnArrowConsumables> <vDnBoltConsumables>

- prefab: TreasureChest_plains_stone
  type: poke, p_treasurechest_dn_consumables
  data: d_treasurechest_dn_consumables
  injectData: true

# Materials
- prefab: TreasureChest_plainsfortress_hildir
  type: create
  biomes: DeepNorth
  weight: 1E30
  poke:
  - self: true
    parameter: p_treasurechest_dn_materials

- prefab: TreasureChest_plainsfortress_hildir
  type: poke, p_treasurechest_dn_materials
  data: d_treasurechest_dn_materials
  injectData: true

# Low Quality
- prefab: TreasureChest_meadows
  type: create
  biomes: DeepNorth
  weight: 1E30
  poke:
  - self: true
    parameter: p_treasurechest_dn_low_quality

- prefab: TreasureChest_meadows
  type: poke, p_treasurechest_dn_low_quality
  data: d_treasurechest_dn_low_quality
  injectData: true


########################################################################
# DEBUG
########################################################################
#- prefab: Player
#  type: say, rl_set
#  data: d_player_roguelite_start
#  injectData: true
#  command: s roguelite status ON
#- prefab: Player
#  type: say, rl_clear
#  data: d_player_roguelite_clear
#  injectData: true
#  command: s roguelite status OFF
#  poke:
#  - prefab: deer_ragdoll
#    maxDistance: 100
#    parameter: p_dnrl_victory_remove_deer_ragdoll
#- prefab: Player
#  type: say, rl_stats
#  command: s State <int_i_player_roguelite_on> Wave <int_i_player_roguelite_wave> Kills <int_i_player_roguelite_kills> BKills <int_i_player_roguelite_boss_kills> STier <int_i_player_roguelite_subtier> Tier <int_i_player_roguelite_tier> BSpawns <int_i_player_roguelite_boss_spawns>  # DEBUG
#- prefab: Player
#  type: say, rl_spawn
#  spawns:
#  - Eikthyr, 0,12,snap, 180,0,0, dn_mob_group_roguelite_eikthyr, 0, true
#- prefab: Player
#  type: say, rl_win
#  poke:
#  - prefab: Player
#    parameter: p_dn_roguelite_win_sequence
#- prefab: Player
#  type: say, rl_t8
#  data: d_player_roguelite_tier_8
#  injectData: true

##############################
# NOTES
# Need to add roaming guardians, inquisitors, and deer!  Hearing range 100 for patrols.
#   God weapon:  secondary casts shield, value scales with Swords.  if shielded, secondary is skybreaker + blackhole + FX.  if FX, primary applies VeryWeak Slash + Slow.  Uses eitr + stam.  fast attack 1h or 2h sword versions.  CWS_Sword_1 / CWS_TH_Sword_5 (recolor green or blue?)?
#   Odin's gifts throughout previous zones are temporal/ethereal versions of them.
#   Purity, Serenity, Tranquility?  synonyms...
#   Bind on Equip??
# Make ancient loot, including buff weapons, odin weapons.
# Finish loot tables for mini-bosses.
# Test unique battleaxe that siphons souls

# Multiplayer Testing
# 1) Difficulty (should have trash per player, but same number of bosses)
# 2) Resurrect does not clear roguelite state, nor trigger end broadcast?
# 3) Loot for only one player?
# 4) players entering late should get tagged with roguelite, to prevent cheesing
# 5) At startup, only broadcast goes to all.  RPC_Message goes only to local player.
