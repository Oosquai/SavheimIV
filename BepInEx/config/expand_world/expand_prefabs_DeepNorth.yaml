# Need to add roaming guardians, inquisitors, and deer!  Hearing range 100 for patrols.
#   God weapon:  secondary casts shield, value scales with Swords.  if shielded, secondary is skybreaker + blackhole + FX.  if FX, primary applies VeryWeak Slash + Slow.  Uses eitr + stam.  fast attack 1h or 2h sword versions.  CWS_Sword_1 / CWS_TH_Sword_5 (recolor green or blue?)?
#   Odin's gifts throughout previous zones are temporal/ethereal versions of them.
#   Purity, Serenity, Tranquility?  synonyms...
#   Bind on Equip??
# Make ancient loot, including buff weapons, odin weapons.
# Finish loot tables for mini-bosses.

# some loot still dropping - blood clots?  gjall maybe?

# Multiplayer Testing
# 1) Difficulty (should have trash per player, but same number of bosses)
# 2) Resurrect does not clear roguelite state, nor trigger end broadcast?
# 3) Loot per player?  Except final reward gear...  coins per player?

## debug
#- prefab: Player
#  type: say, set_rl
#  data: d_player_roguelite_start
#  injectData: true
#  command: s roguelite status ON
#
#- prefab: Player
#  type: say, clear_rl
#  data: d_player_roguelite_clear
#  injectData: true
#  command: s roguelite status OFF

########################################################################
# Deep North
########################################################################
# Killing a deer in Deep North starts the Roguelite minigame.
# Mobs get spawned in Waves at regular intervals.
# Killing mobs has a percent chance to increment Subtier.
# Subtier = 7 increases Tier if conditions are satisfied (enough bosses killed).
# Mobs get harder per tier.  Mini-bosses and bosses spawn at specific tiers.
# Get to Tier 16 and clear all mobs to win!  Get loot from mini-bosses and bosses along the way.
# Die or leave to clear status.  Mobs despawn if no flagged players nearby.
# Normal loot tables removed.
#
# TIER | SPAWNS (* indicates must kill boss before passing.  i.e. must kill Elder/Bonemass before you can advance to tier 3.)
#    0 | chance of eikthyr
#    1 | elder or bonemass
#  * 2 | chance of brenna (if too slow killing previous boss!)
#    3 | dragon or yag
#  * 4 | chance of Geirrhafa (if too slow killing previous boss!)
#  * 5 | queen or fader
#    6 | elder, bonemass, or dragon
#    7 | yagluth, queen, or fader
#    8 | Victory once all mobs cleared

# Don't murder the deer!
- prefab: Deer
  type: destroy
  biomes: DeepNorth
  weight: 1E30
  poke:
  - prefab: Player
    maxDistance: 200
    delay: 5
    parameter: p_deer_murder

- prefab: Player
  type: poke, p_deer_murder
  biomes: DeepNorth                # only in Deep North
  filter: d_player_roguelite_off   # only process if not already started
  data: d_player_roguelite_start   # clear all state for a fresh start
  injectData: true
  spawns:
  - sfx_reaper_idle, 0,0,0, 0,0,0, d_empty_data, 0
  - sfx_gdking_idle, 0,0,0, 0,0,0, d_empty_data, 3
  - sfx_gdking_scream, 0,0,0, 0,0,0, d_empty_data, 6.5
  - sfx_dragon_scream, 0,0,0, 0,0,0, d_empty_data, 6.5
  command: broadcast center <string_playerName> has slain an innocent deer in the tranquil Deep North.
  objectRpc:
  - name: Message
    1: enum_message, 2
    2: string, The land stirs, angry and vengeful ...
    3: int, 0
    delay: 3
  - name: Message
    1: enum_message, 2
    2: string, Blood for blood, a life is forfeit!
    3: int, 0
    delay: 6.5
  poke:
  - prefab: Player   # initial entry into spawner loop, but with randomized startup delay
    maxDistance: 1
    limit: 1
    parameter: dn_roguelite_spawn_dly
  - prefab: Player   # check for player leaving Deep North
    maxDistance: 1
    limit: 1
    delay: 3
    parameter: dn_roguelite_flee_check

####################################
# Randomized delay, for multiplayer, so different players have uniquely timed spawn loops
- prefab: Player
  type: poke, dn_roguelite_spawn_dly
  poke:
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 9
    parameter: dn_roguelite_spawn <dnTrashMobsT0> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>

- prefab: Player
  type: poke, dn_roguelite_spawn_dly
  poke:
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 12
    parameter: dn_roguelite_spawn <dnTrashMobsT0> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>

- prefab: Player
  type: poke, dn_roguelite_spawn_dly
  poke:
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 15
    parameter: dn_roguelite_spawn <dnTrashMobsT0> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>

########################################################################
####################################
# MAIN LOOP - self-looping trash mob spawner
- prefab: Player
  type: poke, dn_roguelite_spawn
  biomes: DeepNorth                     # only process if in Deep North
  filters:
  - int, i_player_roguelite_on, 1       # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 0;7   # Spawns stop at tier 8.  Must clear all mobs to win.
  data: d_player_roguelite_wave_inc     # increment wave counter
  injectData: true
  command: s Wave <int_i_player_roguelite_wave> Kills <int_i_player_roguelite_kills> BKills <int_i_player_roguelite_boss_kills> STier <int_i_player_roguelite_subtier> Tier <int_i_player_roguelite_tier> BSpawns <int_i_player_roguelite_boss_spawns>  # DEBUG
#  command: s BKills <int_i_player_roguelite_boss_kills> STier <int_i_player_roguelite_subtier> Tier <int_i_player_roguelite_tier> Specials <int_i_player_roguelite_special_spawns>  # DEBUG
  spawns:
  - <par1>, 12,12,snap, 225,0,0, dn_mob_group_roguelite, 0, true
  - <par2>, 12,-12,snap, 315,0,0, dn_mob_group_roguelite, 0, true
  - <par3>, -12,12,snap, 135,0,0, dn_mob_group_roguelite, 0, true
  - <par4>, -12,-12,snap, 45,0,0, dn_mob_group_roguelite, 0, true
  poke:
  - prefab: creature                   # remove creatures if player leaves
    maxDistance: 200
    delay: 3
    parameter: dn_roguelite_despawn_check
  - prefab: Player                     # self-looping spawners!
    maxDistance: 1
    limit: 1
    delay: 30                          # loop timer
    data: d_player_roguelite_tier_0    # Player is at Roguelite tier X --> Choose mob set.
    parameter: dn_roguelite_spawn <dnTrashMobsT0> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 30
    data: d_player_roguelite_tier_1
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT0v2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 30
    data: d_player_roguelite_tier_2
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT2> <dnTrashMobsT0v3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 30
    data: d_player_roguelite_tier_3
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT2> <dnTrashMobsT3> <dnTrashMobsT0v4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 30
    data: d_player_roguelite_tier_4
    parameter: dn_roguelite_spawn <dnTrashMobsT1> <dnTrashMobsT2> <dnTrashMobsT3> <dnTrashMobsT4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 30
    data: d_player_roguelite_tier_5
    parameter: dn_roguelite_spawn <dnTrashMobsT5> <dnTrashMobsT2> <dnTrashMobsT3> <dnTrashMobsT4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 30
    data: d_player_roguelite_tier_6
    parameter: dn_roguelite_spawn <dnTrashMobsT5> <dnTrashMobsT5v2> <dnTrashMobsT3> <dnTrashMobsT4>
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 30
    data: d_player_roguelite_tier_7
    parameter: dn_roguelite_spawn <dnTrashMobsT5> <dnTrashMobsT5v2> <dnTrashMobsT5v3> <dnTrashMobsT4v2>
####################################
########################################################################

####################################
# Limit to one of each boss & miniboss at a time.  Don't spawn GoblinBruteBros, since I'm too lazy to script checking for the shaman to avoid respawning the pair!
- prefab: Eikthyr, gd_king, Bonemass, Dragon, GoblinKing, SeekerQueen, Fader, Skeleton_Hildir, Fenring_Cultist_Hildir
  type: create
  biomes: DeepNorth
  objects:
  - <prefab>, 200
  weight: 1E30
  remove: true

####################################
# Track mob kills, increase tier variable to control ramping difficulty
# Note, there are versions of this process below in the Loot! section for bosses.
- prefab: creature
  type: destroy
  biomes: DeepNorth
  filter: dn_mob_group_roguelite         # make sure it's a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on   # make sure there's a player nearby with roguelite mode on
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill   # all nearby players poked for kill, subtier, and boss checks
  - prefab: Player
    maxDistance: 200
    limit: 1                             # only nearest player poked for win check, to avoid multiple Odin / reward spawns
    data: d_player_roguelite_on          # check for player has roguelite active
    parameter: p_dn_roguelite_win_check

- prefab: Player
  type: poke, p_dn_roguelite_mob_kill
  biomes: DeepNorth                    # only process if in Deep North
  filter: d_player_roguelite_on        # only process if player has started roguelite (by killing deer)
  data: d_player_roguelite_kills_inc   # increment kills counter
  injectData: true
  poke:
  - prefab: Player
    maxDistance: 1
    limit: 1
    parameter: p_dn_roguelite_subtier_check  # every kill = % chance to advance subtier
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 3
    parameter: p_dn_roguelite_boss_check     # every kill = check for boss spawn conditions

- prefab: Player
  type: poke, p_dn_roguelite_boss_kill
  biomes: DeepNorth                        # only process if in Deep North
  filter: d_player_roguelite_on            # only process if player has started roguelite (by killing deer)
  data: d_player_roguelite_boss_kills_inc  # increment boss kills counter
  injectData: true

# Subtiers count toward tier increments, but slightly random because ... RNG is fun!
- prefab: Player
  type: poke, p_dn_roguelite_subtier_check
  biomes: DeepNorth
  filter: d_player_roguelite_on
  weight: 0.85                            # percent chance to increment subtier counter
  data: d_player_roguelite_subtier_inc    # increment subtier counter
  injectData: true
  poke:
  - prefab: Player
    maxDistance: 1
    limit: 1
    parameter: p_dn_roguelite_tier_check  # if subtier increased, check if ready to advance to next tier

####################################
# Tier checks.  Must kill bosses to get past certain tiers.  Eikthyr doesn't count.
- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1           # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 7;999  # should trigger at 7, but just in case someone kills a bunch of mobs in one hit somehow...
  - int, i_player_roguelite_boss_kills, 0   # Need to kill Elder or Bonemass ...
  - int, i_player_roguelite_tier, 0;1       # ... to advance as high as tier X+1 = 2
  data: d_player_roguelite_tier_inc         # If all requirements met, increment tier counter (also resets subtier counter)
  injectData: true

- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1
  - int, i_player_roguelite_subtier, 7;999
  - int, i_player_roguelite_boss_kills, 1   # Need to kill Moder or Yagluth ...
  - int, i_player_roguelite_tier, 1;3       # ... to advance as high as tier X+1 = 4
  data: d_player_roguelite_tier_inc
  injectData: true

- prefab: Player
  type: poke, p_dn_roguelite_tier_check
  biomes: DeepNorth
  filters:
  - int, i_player_roguelite_on, 1
  - int, i_player_roguelite_subtier, 7;999
  - int, i_player_roguelite_boss_kills, 2;999  # Need to kill Queen or Fader, then 2 other bosses ...
  - int, i_player_roguelite_tier, 3;7          # ... to advance to victory!  (if you clear all mobs)
  data: d_player_roguelite_tier_inc
  injectData: true

########################################################################
# Boss and mini-boss spawners
### Tier 0 - Eikthyr
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 0.1                                  # % chance per kill to spawn.  about 10 kills per tier, but starting halfway through this tier...  so about 50%.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 0            # check tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_eikthyr_spawn, 0   # check that one hasn't spawned yet for this tier
  data: d_player_roguelite_eikthyr_spawn       # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Eikthyr, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

### Tier 1 - Elder or Bonemass
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 1;2          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 0     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - gd_king, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 1;2          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 0     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Bonemass, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

### Tier 2 - Brenna
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 0.1                                  # % chance per kill to spawn.  about 10 kills per tier, but starting halfway through this tier...  so about 50%.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 2            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_brenna_spawn, 0    # check that one hasn't spawned yet for this tier
  data: d_player_roguelite_brenna_spawn        # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Skeleton_Hildir, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

### Tier 3 - Moder or Yagluth
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 3;4          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 1     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Dragon, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 3;4          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 1     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - GoblinKing, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

### Tier 4 - Geirrhafa
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 0.1                                  # % chance per kill to spawn.  about 10 kills per tier, but starting halfway through this tier...  so about 50%.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 4            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_geirrhafa_spawn, 0 # check that one hasn't spawned yet for this tier
  data: d_player_roguelite_geirrhafa_spawn     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Fenring_Cultist_Hildir, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

### Tier 5 - Queen or Fader
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 5;6          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 2     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - SeekerQueen, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # 50% chance of this or the other boss this tier, not both.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_subtier, 3;999     # wait until about halfway through subtier
  - int, i_player_roguelite_tier, 5;6          # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 2     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Fader, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

### Tier 6 - Elder, Bonemass, or Moder
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 6            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 3     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - gd_king, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 6            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 3     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Bonemass, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 6            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 3     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Dragon, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

### Tier 7 - Yagluth, Queen, or Fader
- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 7            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 4     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - GoblinKing, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 7            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 4     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - SeekerQueen, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

- prefab: Player
  type: poke, p_dn_roguelite_boss_check
  biomes: DeepNorth                            # only process if in Deep North
  weight: 1                                    # equal chances for all 3 bosses this tier, but only one will spawn.
  filters:
  - int, i_player_roguelite_on, 1              # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 7            # CHECK tier to determine which mini-boss or boss to spawn
  - int, i_player_roguelite_boss_spawns, 4     # CHECK that one hasn't spawned yet for this tier
  data: d_player_roguelite_boss_spawns_inc     # if filters pass, prevent another spawn this tier
  injectData: true
  spawns:
  - Fader, 0,12,snap, 180,0,0, dn_mob_group_roguelite, 0, true

########################################################################
# Loot!
# Raaka's trick for removing loot, used here with mobs spawned by roguelite - thanks, Raaka!
# Any itemdrop created above 9000y altitude is instantly removed.    
- prefab: ItemDrop
  type: create
  biomes: DeepNorth
  minY: 9000
  remove: true

# The altitude trick doesn't help with creatures who leave ragdolls though, so another Raaka trick!
# Swap ragdolls, causing them to abandon their loot tables
#- prefab: Abomination_ragdoll, Charred_Melee_Ragdoll, Draugr_elite_ragdoll, eikthyr_ragdoll, Fenring_cultist_ragdoll, Fenring_ragdoll, gdking_Ragdoll, GoblinBrute_ragdoll, GoblinKing_ragdoll, GoblinShaman_ragdoll, Greydwarf_elite_ragdoll, Greydwarf_Shaman_ragdoll, Hatchling_ragdoll, lox_ragdoll, Stonegolem_ragdoll, Troll_ragdoll, Ulv_Ragdoll
- prefab: Ragdoll
  type: create
  biomes: DeepNorth
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  remove: true
  spawn:
  - prefab: <prefab>
    triggerRules: false

# Also reduce clutter by removing Enchanting loot
- prefab: kg_EnchantSkillScroll_F, kg_EnchantSkillScroll_D, kg_EnchantSkillScroll_C, kg_EnchantSkillScroll_B, kg_EnchantSkillScroll_A, kg_EnchantSkillScroll_S, kg_EnchantScroll_Weapon_Blessed_F, kg_EnchantScroll_Weapon_Blessed_D, kg_EnchantScroll_Weapon_Blessed_C, kg_EnchantScroll_Weapon_Blessed_B, kg_EnchantScroll_Weapon_Blessed_A, kg_EnchantScroll_Weapon_Blessed_S, kg_EnchantScroll_Weapon_F, kg_EnchantScroll_Weapon_D, kg_EnchantScroll_Weapon_C, kg_EnchantScroll_Weapon_B, kg_EnchantScroll_Weapon_A, kg_EnchantScroll_Weapon_S, kg_EnchantScroll_Armor_Blessed_F, kg_EnchantScroll_Armor_Blessed_D, kg_EnchantScroll_Armor_Blessed_C, kg_EnchantScroll_Armor_Blessed_B, kg_EnchantScroll_Armor_Blessed_A, kg_EnchantScroll_Armor_Blessed_S, kg_EnchantScroll_Armor_F, kg_EnchantScroll_Armor_D, kg_EnchantScroll_Armor_C, kg_EnchantScroll_Armor_B, kg_EnchantScroll_Armor_A, kg_EnchantScroll_Armor_S
  type: create
  biomes: DeepNorth
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  remove: true

# If a boss was killed, special counter incremented in addition to everything else, plus loot!
- prefab: Eikthyr
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 11
    parameter: p_boss_loot_dn_roguelite_no_coin <bossDropsEikthyrDnRoguelite>

- prefab: gd_king
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 12
    parameter: p_boss_loot_dn_roguelite <bossDropsElderDnRoguelite>

- prefab: Bonemass
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 5
    parameter: p_boss_loot_dn_roguelite <bossDropsBonemassDnRoguelite>

- prefab: Dragon
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 8
    parameter: p_boss_loot_dn_roguelite <bossDropsDragonDnRoguelite>

- prefab: GoblinKing
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 10
    parameter: p_boss_loot_dn_roguelite <bossDropsYagluthDnRoguelite>

- prefab: SeekerQueen
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 6
    parameter: p_boss_loot_dn_roguelite <bossDropsQueenDnRoguelite>

- prefab: Fader
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (bosses count as a kill)
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_boss_kill    # also increment boss kill counter
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 14
    parameter: p_boss_loot_dn_roguelite <bossDropsFaderDnRoguelite>

# Mini-bosses
- prefab: Skeleton_Hildir
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (mini-bosses count as a kill)
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 3
    parameter: p_boss_loot_dn_roguelite_no_coin <bossDropsBrennaDnRoguelite>

# Mini-bosses
- prefab: Fenring_Cultist_Hildir
  type: destroy
  weight: 1E30                             # force this to trigger instead of "creature" process above
  biomes: DeepNorth
  filter: dn_mob_group_roguelite           # must be a roguelite mob
  objects:
  - Player, 200, d_player_roguelite_on     # must be a nearby player with roguelite active
  poke:
  - prefab: Player
    maxDistance: 200
    parameter: p_dn_roguelite_mob_kill     # increment kill counter (mini-bosses count as a kill)
  - prefab: Player
    maxDistance: 100
    limit: 1
    delay: 3
    parameter: p_boss_loot_dn_roguelite_no_coin <bossDropsGeirrhafaDnRoguelite>

# Boss Loot.  No coins from Eikthyr or mini-bosses.
- prefab: Player
  type: poke, p_boss_loot_dn_roguelite_no_coin
  spawns:
  - <par1>, 0,0,snap, 0,0,0, d_empty_data, 0
  - fx_chainlightning_hit, 0,0,snap, 0,0,0, d_empty_data, 0
  - fx_lightningweapon_hit, 0,0,snap, 0,0,0, d_empty_data, 0.2
  - fx_DvergerMage_Mistile_die, 0,0,snap, 0,0,0, d_empty_data, 0.2
  - vfx_coin_pile_destroyed, 0,0,snap, 0,0,0, d_empty_data, 0.35
  - sfx_coins_destroyed, 0,0,snap, 0,0,0, d_empty_data, 0.35

- prefab: Player
  type: poke, p_boss_loot_dn_roguelite
  spawns:
  - <par1>, 0,0,snap, 0,0,0, d_empty_data, 0
  - JC_Gacha_Coins, 0,0,snap, 0,0,0, d_empty_data, 0
  - fx_chainlightning_hit, 0,0,snap, 0,0,0, d_empty_data, 0
  - fx_lightningweapon_hit, 0,0,snap, 0,0,0, d_empty_data, 0.2
  - fx_DvergerMage_Mistile_die, 0,0,snap, 0,0,0, d_empty_data, 0.2
  - vfx_coin_pile_destroyed, 0,0,snap, 0,0,0, d_empty_data, 0.35
  - sfx_coins_destroyed, 0,0,snap, 0,0,0, d_empty_data, 0.35

########################################################################
# Roguelite Win Conditions
# Must have made it to tier 16 (spawns stopped) and cleared all nearby roguelite mobs
- prefab: Player
  type: poke, p_dn_roguelite_win_check
  biomes: DeepNorth                         # only process if in Deep North
  filters:
  - int, i_player_roguelite_on, 1           # roguelite mode must be active for player
  - int, i_player_roguelite_tier, 8;9999    # Player must be at least tier 8
  bannedObjects:
  - creature, 200, dn_mob_group_roguelite   # no nearby creatures tagged as roguelite mob
  poke:
  - prefab: Player
    maxDistance: 1
    limit: 1
    delay: 16
    parameter: p_dn_roguelite_win_sequence <rogueliteLoot>  # You win!

- prefab: Player
  type: poke, p_dn_roguelite_win_sequence
  biomes: DeepNorth                         # only process if in Deep North
  command: broadcast center <string_playerName> has triumphed over the fury of the Deep North!  They conquered <int_i_player_roguelite_wave> waves and killed <int_i_player_roguelite_kills> creatures.  Odin honors this worthy champion!
  data: d_player_roguelite_clear
  injectData: true
  spawns:
  - Odin, 0,8,snap, 180,0,0, d_odin_persist, 0
  - sfx_haldor_yea, 0,8,snap, d_empty_data, 1
  - sfx_haldor_laugh, 0,8,snap, d_empty_data, 3
  - vfx_FireWork_BlackCore, 0,12,2 0,0,0, d_empty_data, 3.2
  - vfx_Firework_Rocket_Red, 12,11,-4 0,0,0, d_empty_data, 3.8
  - sfx_firework_explode, 12,11,-4 0,0,0, d_empty_data, 3.8
  - vfx_Firework_Rocket_Yellow, -23,12,snap 0,0,0, d_empty_data, 4.2
  - sfx_firework_explode, -23,12,snap 0,0,0, d_empty_data, 4.2
  - vfx_Firework_Rocket_Cyan, 1,6,12 0,0,0, d_empty_data, 4.7
  - sfx_firework_explode, 1,6,12 0,0,0, d_empty_data, 4.7
  - vfx_Firework_Rocket_Purple, -13,15,-9 0,0,0, d_empty_data, 5.1
  - sfx_firework_explode, -13,15,-9 0,0,0, d_empty_data, 5.1
  - vfx_Firework_Rocket_Green, 17,17,snap 0,0,0, d_empty_data, 5.4
  - sfx_firework_explode, 17,17,snap 0,0,0, d_empty_data, 5.4
  - fx_HildirChest_Unlock, 0,6,snap, 0,0,0, d_sfx_silent, 16
  - fx_chainlightning_hit, 0,6,snap, 0,0,0, d_empty_data, 16
  - fx_lightningweapon_hit, 0,6,snap, 0,0,0, d_empty_data, 16.2
  - fx_DvergerMage_Mistile_die, 0,6,snap, 0,0,0, d_empty_data, 16.2
  - vfx_coin_pile_destroyed, 0,6,snap, 0,0,0, d_empty_data, 16.35
  - sfx_coins_destroyed, 0,6,snap, 0,0,0, d_empty_data, 16.35
  - <par1>, 0,6,snap, 0,0,0, d_empty_data, 16
  - MoltenCore, 0,6,snap, 0,0,0, d_empty_data, 16
  - JC_Gacha_Coins, 0,6,snap, 0,0,0, d_empty_data, 16
  - JC_Gacha_Coins, 0,6,snap, 0,0,0, d_empty_data, 16
  - JC_Gacha_Coins, 0,6,snap, 0,0,0, d_empty_data, 16
  - sfx_haldor_greet, 0,8,snap, d_empty_data, 19
  poke:
  - prefab: Odin     # Odin prevented from leaving during reward sequence
    delay: 24        # let him leave once it concludes
    maxDistance: 50
    parameter: p_odin_closer

- prefab: Odin
  type: poke, p_odin_closer
  data: d_odin_closer
  injectData: true

########################################################################
# Clean up player state and mobs, broadcast results
# Clear state if player dies and releases (getting resurrected shouldn't trigger this)
- prefab: Player
  type: destroy
  biomes: DeepNorth
  filter: d_player_roguelite_on
  commands:
  - broadcast center <string_playerName> has been consumed by the wrath of the Deep North!  They survived <int_i_player_roguelite_wave> waves and killed <int_i_player_roguelite_kills> creatures before meeting their end.
  - s <string_playerName> has been consumed by the wrath of the Deep North!  They survived <int_i_player_roguelite_wave> waves and killed <int_i_player_roguelite_kills> creatures before meeting their end.
  data: d_player_roguelite_clear
  injectData: true

# Clear state if player leaves Deep North
- prefab: Player
  type: poke, dn_roguelite_flee_check
  filter: d_player_roguelite_on        # check if roguelite active
  poke:
  - prefab: Player                     # self-loop for repeated checks as long as roguelite active
    maxDistance: 1
    limit: 1
    delay: 3
    parameter: dn_roguelite_flee_check
  - prefab: Player                     # try to remove roguelite mode
    maxDistance: 1
    limit: 1
    data: d_player_roguelite_on
    parameter: dn_roguelite_flee_remove

- prefab: Player
  type: poke, dn_roguelite_flee_remove
  biomes: Meadows, Blackforest, Swamp, Ocean, Mountain, Plains, Mistlands, AshLands
  filter: d_player_roguelite_on        # check if roguelite active in zone other than Deep North
  data: d_player_roguelite_clear
  injectData: true
  commands:
  - broadcast center <string_playerName> has fled the wrath of the Deep North!  They braved <int_i_player_roguelite_wave> waves and killed <int_i_player_roguelite_kills> creatures before running away.
  - s <string_playerName> has fled the wrath of the Deep North!  They braved <int_i_player_roguelite_wave> waves and killed <int_i_player_roguelite_kills> creatures before running away.

# roguelite_remove_failsafe - any action when not in Deep North clears roguelite state
- prefab: Player
  type: state, *
  biomes: Meadows, Blackforest, Swamp, Ocean, Mountain, Plains, Mistlands, AshLands
  filter: d_player_roguelite_on
  data: d_player_roguelite_clear
  injectData: true
  command: s DEBUG - triggered roguelite_remove_failsafe

# Remove mobs if no player nearby
- prefab: creature
  type: poke, dn_roguelite_despawn_check
  biomes: DeepNorth
  poke:
  - prefab: creature                   # self-loop for stragglers on all mobs
    maxDistance: 1
    limit: 1
    delay: 3
    parameter: dn_roguelite_despawn_check
  - prefab: creature                   # try to remove roguelite mobs
    maxDistance: 200
    data: dn_mob_group_roguelite
    parameter: dn_roguelite_despawn
  
- prefab: creature
  type: poke, dn_roguelite_despawn
  biomes: DeepNorth
  bannedObjects:
  - Player, 200, d_player_roguelite_on  # only remove if no players with roguelite active nearby
  filter: dn_mob_group_roguelite        # only remove mobs associated with roguelite
  remove: true

########################################################################
# Spawn data and specific creature data
####################################
# Spawn data
- prefab: Deer
  type: create
  biomes: DeepNorth
  data: dn_deer

- prefab: Eikthyr
  type: create
  biomes: DeepNorth
  data: dn_eikthyr

####################################
# Eikthyr
# Extra attacks to give Eikthyr damage appropriate for Deep North
- prefab: Eikthyr
  type: state, attack1
  biomes: DeepNorth
  poke:
  - prefab: Player, creature
    delay: 0.7
    maxDistance: 4
    parameter: p_eikthyr_attack1 <dnEikthyrDmgPlayer> <dnEikthyrDmgTame>

- prefab: Eikthyr
  type: state, attack2
  biomes: DeepNorth
  poke:
  - prefab: Player, creature
    delay: 1.6
    maxDistance: 16
    parameter: p_eikthyr_attack2 <dnEikthyrDmgPlayer> <dnEikthyrDmgTame>

- prefab: Eikthyr
  type: state, attack_stomp
  biomes: DeepNorth
  poke:
  - prefab: Player, creature
    delay: 3
    maxDistance: 8
    parameter: p_eikthyr_attack_stomp <dnEikthyrDmgPlayer> <dnEikthyrDmgTame>

- prefab: Player
  type: poke, p_eikthyr_attack1
  objectRpc:
  - name: RPC_Damage
    1: hit, slash=<par1> dodge=true block=true

- prefab: Creature
  type: poke, p_eikthyr_attack1
  filter: tamed
  objectRpc:
  - name: RPC_Damage
    1: hit, slash=<par2> dodge=true block=true

- prefab: Player
  type: poke, p_eikthyr_attack2
  spawn: fx_chainlightning_hit
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par1> dodge=true block=true

- prefab: Creature
  type: poke, p_eikthyr_attack2
  filter: tamed
  spawn: fx_chainlightning_hit
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par2> dodge=true block=true

- prefab: Player
  type: poke, p_eikthyr_attack_stomp
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par1> dodge=true block=true

- prefab: Creature
  type: poke, p_eikthyr_attack_stomp
  filter: tamed
  objectRpc:
  - name: RPC_Damage
    1: hit, lightning=<par2> dodge=true block=true

####################################
# Elder
# Elder Tentaroots move around - creepy!  (Thanks, Raaka!)
- prefab: TentaRoot
  type: create
  biomes: DeepNorth
  objects:
  - gd_king, 200
  data: TentaRootMover_dnrl

# tentaroots slime nearby players when they attack.  (Thanks, Raaka!)
- prefab: TentaRoot
  type: state, *
  biomes: DeepNorth
  poke: 
  - prefab: Player, creature
    limit: 5
    maxDistance: 4.1
    delay: 1.45
    parameter: tentarootslimed
    
- prefab: Player
  type: poke, tentarootslimed
  objectRpc:
  - name: RPC_Damage
    1: hit, status=Slimed dodge=true block=true

- prefab: creature
  type: poke, tentarootslimed
  filter: tamed
  objectRpc:
  - name: RPC_Damage
    1: hit, status=Slimed dodge=true block=true

########################################################################
# DEBUG
########################################################################
#- prefab: Player
#  type: say, test
#  poke:
#  - prefab: Player
#    maxDistance: 1
#    limit: 1
#    delay: 1
#    parameter: p_boss_loot_dn_roguelite <Coins>
## DEBUG - remove all item drops, including anything a player throws on the ground!
#- prefab: ItemDrop
#  type: create
#  biomes: DeepNorth
#  command: s removed drop <prefab>!
#  remove: true
#
## remove normal loot table - really only needed if making him 50 stars, which we're not.
#- prefab: eikthyr_ragdoll
#  type: create
#  remove: true
#  spawn: <prefab>, 0,0,0, 0,0,0, d_empty_data, 0, true
#
## debug
#- prefab: Player
#  type: say, test
#  poke:
#  - prefab: Player
#    parameter: testVG <vgNums> <vgNums> <vgNums>
#
#- prefab: Player
#  type: poke, testVG
#  command: s <par1> <par2> <par3>
