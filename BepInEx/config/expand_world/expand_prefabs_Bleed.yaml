###############################################################
# Bleed Mechanics
# Secondary attacks from swords and greatswords cause bleed against staggered enemies.
# Greatswords get more ticks than 1h swords.
# Claw primary attacks have a chance to trigger bleed, but with shorter duration.
# Bleed arrows and bolts always bleed, but much shorter duration.
# Reapplications reset count and add a second set of increased ticks, for stacking damage.
# More stacks makes ticks faster too though, so can't stack infinitely.
# Damage and tick count scales roughly with creature max hp.

# 1h swords
- prefab: sfx_rebirth               # Wacky's Database SE adds this, to ensure only occurs on hit.
  type: create
  objects:
  - sfx_build_hoe, 1                # Wacky's Database SE sfx added to secondary attacks of 1h swords only
  - sfx_perfectblock, 5             # Only trigger after parry.  sfx shortened to 3s in expand_prefabs.yaml.  need range in case player moves after parry
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6                  # big range for big creatures (troll 2.  bonemass 4.  8-star bonemass 6)
    parameter: p_sword_bleed_hp 7   # par1 = base total ticks minus 1

# 2h swords
- prefab: sfx_rebirth
  type: create
  objects:
  - sfx_build_cultivator, 1         # specific to greatswords
  - sfx_perfectblock, 5
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 13

# claws - chance to bleed on primary attacks.  this is also used with Ryvers (CWS_Sword_5_SH).
# chance achieved with Wacky's Database chance to proc SE on attack
- prefab: sfx_rebirth               # Wacky's Database SE adds this, to ensure only occurs on hit.
  type: create
  objects:
  - sfx_gui_craftitem_end, 1        # specific to claws and Ryvers
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 1   # more frequent but shorter duration bleeds

# bleed arrows and bolts
- prefab: sfx_rebirth
  type: create
  objects:
  - sfx_gui_craftitem, 1            # specific to bleed arrows and bolts
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 0   # on-demand bleed arrows have short duration, but can rapidly stack, especially against high hp enemies

# unique melee bow - huntress.  bleeds on parry.
- prefab: sfx_perfectblock
  type: create
  objects:
  - Player, 1, PlayerBlockingHuntressBow
  weight: 0.6
  poke:
  - prefab: creature
    limit: 1
    maxDistance: 6
    parameter: p_sword_bleed_hp 3
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    delay: 3
    parameter: p_sfx_perfectblock_cancel

##########################
# Some creatures don't bleed
# Intercept with no-op
- prefab: Skeleton, Skeleton_Poison, Ghost, Wraith, StoneGolem, GoblinKing, Charred_Archer, Charred_Melee, Charred_Mage, Charred_Twitcher, Morgen
  type: poke, p_sword_bleed_hp
  weight: 1E30

##########################
# Check max hp of creature to set tick damage and extra tick count
# RPC_Damage wants an int, and no way to type convert...
# Brute force Fibonacci to solve... obviously??
- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 0;99         # victim health range
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+0 1  # ticks, dmg per tick

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 100;199
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+1 2

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 200;299
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+2 3

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 300;499
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+3 4

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 500;799
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+4 5

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 800;1299
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+5 6

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 1300;2099
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+6 7

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 2100;3399
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+7 8

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 3400;5499
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+8 9

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 5500;8899
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+9 10

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 8900;14399
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+10 11

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 14400;23299
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+11 12

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 23300;37699
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+12 13

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 37700;60999
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+13 14

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 61000;98699
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+14 15

- prefab: creature
  type: poke, p_sword_bleed_hp
  filter: float, max_health, 98700;999999
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_fx <par1>+15 16

# Bleed fx
- prefab: creature
  type: poke, p_sword_bleed_fx
  data: d_bleed_tick_rst_stack_inc     # reset tick count and increment stack count any time a new stack is created
  injectData: true
  spawns:
  - fx_bloodweapon_hit, 0,0,1, 0,0,0, d_empty_data, 0.06
  - fx_bloodweapon_hit, 0,0,1.6, 0,0,0, d_empty_data, 0.12
  - fx_bloodweapon_hit, 0,0,2.2, 0,0,0, d_empty_data, 0.18
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data, 0
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data, 0.4
  - sfx_tick_attack_drain, 0,0,0, 0,0,0, d_empty_data, 0.8
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    parameter: p_sword_bleed_loop <par1> <par2>+<par2>*<int_i_bleed_stack_cnt>

# Main Bleed Loop.  Count to X, then exit.
- prefab: creature
  type: poke, p_sword_bleed_loop
  filter: int, i_bleed_tick_cnt, 0;<par1>   # check tick count
  data: d_bleed_tick_cnt_inc                # increment tick count and clear i_bleed_stack_timeout flag
  injectData: true
  objectRpc:
  - name: RPC_Damage
    1: hit, damage=<par2>                   # apply tick damage
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    delay: 1
    parameter: p_sword_bleed_loop <par1> <par2>  # self loop
### DEBUG - COMMENT OUT ###
#  command: s <int_i_bleed_tick_cnt>
###########################

# once count exceeds limit, fallback process will clear all stacks
- prefab: creature
  type: poke, p_sword_bleed_loop
  data: d_bleed_stack_timeout_set  # attempt to clear all bleed state. will only succeed if no other poke loops still active.
  injectData: true
  poke:
  - prefab: <prefab>
    limit: 1
    maxDistance: 1
    delay: 1.1                     # need this delay to clear all stacks
    parameter: p_sword_bleed_clear
  fallback: true

# clear bleed stacks
- prefab: creature
  type: poke, p_sword_bleed_clear
  filter: int, i_bleed_stack_timeout, 1
  data: d_bleed_full_rst
  injectData: true
