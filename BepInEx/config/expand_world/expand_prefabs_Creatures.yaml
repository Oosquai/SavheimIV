##############################################################
# Savheim Creature AI - prefabs
##############################################################
# Prevent night time spawns in Meadows
- prefab: Goblin, SeekerBrood, Tick, Seeker, Charred_Melee, Charred_Archer, Charred_Twitcher, Charred_Mage
  type: create
  biomes: Meadows
  remove: true

# Fix Ashlands?  (Thanks, Raaka!)
- prefab: MonsterAI
  biomes: AshLands
  type: create
  weight: 1
  data: deaf_canswim
  fallback: true

##############################################################
# All mobs can swim (Raaka) - UNTESTED.  Also, blocks other type: create, like clothing, hence weight: 0.1
- prefab: creature
  type: create
  weight: 0.1
  data: canswim
  fallback: true

###############################################################
# Special enemies don't stagger when parried
- prefab: Greydwarf_Elite, Troll, Abomination, Serpent, StoneGolem, GoblinBrute, GoblinBruteBros, GoblinBrute_Hildir, SeekerBrute, Gjall, BonemawSerpent, Morgen, Charred_Archer, Surtling
  type: create
  data: d_no_stagger

###############################################################
# Random clothes for creatures
# gear_buff(RandomSkillFactor)
# ... but mobs created by game don't have a RandomSkillFactor field, so would be 0.  Use "1".
- prefab: Skeleton
  type: create
  weight: 1E30
  biomes: Swamp, Ocean, Mountain, Plains, Mistlands, AshLands
  data: clothes_skeleton_icestaff
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1

- prefab: Skeleton
  type: create
  weight: 1E30
  biomes: Meadows, Blackforest
  data: clothes_skeleton
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1

- prefab: Skeleton_Poison
  type: create
  weight: 1E30
  data: clothes_skeleton_poison
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1

- prefab: Skeleton_Hildir
  type: create
  weight: 1E30
  data: clothes_skeleton_hildir

- prefab: Draugr
  type: create
  weight: 1E30
  data: clothes_draugr
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1

- prefab: Draugr_Elite
  type: create
  weight: 1E30
  data: clothes_draugr_elite
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1

- prefab: Goblin
  type: create
  biomes: Blackforest, Swamp, Ocean, Mountain, Plains, Mistlands, AshLands, DeepNorth
  weight: 1E30
  data: clothes_goblin
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1
  - prefab: <prefab>
    parameter: gear_buff_goblin_spear_no_stagger
    delay: 0.2

- prefab: GoblinBrute
  type: create
  weight: 1E30
  data: clothes_goblin_brute
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1

- prefab: DvergerMage
  type: create
  weight: 1E30
  data: clothes_dverger_mage_allied_group

- prefab: Charred_Melee
  type: create
  biomes: Blackforest, Swamp, Ocean, Mountain, Plains, Mistlands, AshLands, DeepNorth
  weight: 1E30
  data: clothes_charred_melee
  poke:
  - prefab: <prefab>
    parameter: gear_buff 1
    delay: 0.1
    maxDistance: 0.1

- prefab: Charred_Mage
  type: create
  biomes: Blackforest, Swamp, Ocean, Mountain, Plains, Mistlands, AshLands, DeepNorth
  weight: 1E30
  data: clothes_charred_mage

###############################################################
# Any creature with a shield has increased hp and behaves like a tank.
# HP scales with CLLC stars.
- prefab: creature
  type: poke, gear_buff
  filter: gear_shield
  data: gear_shield_buff

#############################
# Skeleton and Draugr archers don't get staggered
- prefab: creature
  type: poke, gear_buff
  filter: gear_bow
  data: d_no_stagger

- prefab: Goblin
  type: poke, gear_buff_goblin_spear_no_stagger
  filter: gear_goblin_spear
  data: d_no_stagger

#############################
# Any creature with an offhand weapon deals increased dmg and behaves like a combat rogue
# Dmg scales with CLLC stars.
- prefab: creature
  type: poke, gear_buff
  filter: gear_dual_wield
  data: gear_dw_buff

###################
# Dual wield creatures attack twice
# Enemies and summons need separate processes for the "objects" filter to ensure they're near enough a valid target.
# Clear flag to make sure only one guaranteed extra attack
- prefab: creature
  type: poke, p_dw_extra_attack_clr
  data: dw_second_attack_cd0
  injectData: true
  poke:
  - self: true
    parameter: p_dw_extra_attack

# perform second attack.  animations are gated by creature, so only those able to do "swing_longsword" will match.
- prefab: creature
  type: poke, p_dw_extra_attack
  objects:
  - Player, 2.5
  - creature, 2.5, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, attack
  - name: SetTrigger
    target: all
    1: name, swing_longsword
  - name: SetTrigger
    target: all
    1: name, attack0
  - name: SetTrigger
    target: all
    1: name, attack_thrust

# summons version - clear flag, then call summon version of extra attack
- prefab: creature
  type: poke, p_dw_extra_attack_clr_summon
  data: dw_second_attack_cd0
  injectData: true
  poke:
  - self: true
    parameter: p_dw_extra_attack_summon

# summons version - checks for enemy near enough to hit instead of {player, tame}
- prefab: creature
  type: poke, p_dw_extra_attack_summon
  objects:
  - creature, 2.5, not_tamed_creatures
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, attack
  - name: SetTrigger
    target: all
    1: name, swing_longsword
  - name: SetTrigger
    target: all
    1: name, attack0
  - name: SetTrigger
    target: all
    1: name, attack_thrust

# creature-specific attack animations and timings
- prefab: Skeleton
  type: state, attack
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 1.5
    parameter: p_dw_extra_attack_clr

# summon versions of skeleton
- prefab: BMR_SummonSkeleton, Skeleton_Friendly
  type: state, attack
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 1.5
    parameter: p_dw_extra_attack_clr_summon

- prefab: Draugr
  type: state, attack
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 2
    parameter: p_dw_extra_attack_clr

- prefab: BMR_SummonDraugr
  type: state, attack
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 2
    parameter: p_dw_extra_attack_clr_summon

- prefab: Goblin
  type: state, swing_longsword
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 1.5
    parameter: p_dw_extra_attack_clr

- prefab: BMR_SummonGoblin
  type: state, swing_longsword
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 1.5
    parameter: p_dw_extra_attack_clr_summon

- prefab: GoblinBrute
  type: state, attack1
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 1.7
    parameter: p_dw_extra_attack_clr

- prefab: Charred_Melee
  types:
  - state, attack_swing
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 1.5
    parameter: p_dw_extra_attack_clr

- prefab: BMR_SummonCharredMelee
  types:
  - state, attack_swing
  filter: gear_dual_wield_cd0
  data: dw_second_attack_cd1
  injectData: true
  poke:
  - self: true
    delay: 1.5
    parameter: p_dw_extra_attack_clr_summon

##################
# Creatures who can't dual wield, but give them a % chance for a quick follow-up attack.
# keep chances below 50%, then no need for flag to prevent infinite attacks - random instead!
# creature-specific attack animations and timings.
- prefab: Greydwarf_Elite
  type: state, attack
  weight: 0.35
  poke:
  - self: true
    delay: 1.7
    parameter: p_extra_attack

- prefab: Skeleton_Hildir
  type: state, attack
  weight: 0.45
  poke:
  - self: true
    delay: 1.8
    parameter: p_extra_attack_brenna

- prefab: Draugr_Elite
  type: state, attack
  weight: 0.4
  poke:
  - self: true
    delay: 2
    parameter: p_extra_attack

- prefab: Skeleton_Poison
  type: state, attack_mace
  weight: 0.35
  poke:
  - self: true
    delay: 2.5
    parameter: p_extra_attack

- prefab: Fenring
  types:
  - state, attack_claw0
  weight: 0.4
  poke:
  - self: true
    delay: 1.5
    parameter: p_extra_attack

- prefab: creature
  type: poke, p_extra_attack
  objects:
  - Player, 2.5
  - creature, 2.5, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, attack
  - name: SetTrigger
    target: all
    1: name, attack_mace
  - name: SetTrigger
    target: all
    1: name, attack_claw1  # this triggers brenna, hence special case below

- prefab: Skeleton_Hildir
  type: poke, p_extra_attack_brenna
  objects:
  - Player, 2.5
  - creature, 2.5, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, attack

#############################
# Any creature with an offhand elemental staff casts novas, so slow their attacks
- prefab: creature
  type: poke, gear_buff
  filter: gear_staff_ice_shards
  data: gear_staff_novas_buff

- prefab: creature
  type: poke, gear_buff
  filter: gear_staff_fireball
  data: gear_staff_novas_buff

#############################
# Any creature with a torch or lantern has increased alert range and causes character to alert other creatures
- prefab: creature
  type: poke, gear_buff
  filter: gear_alert_left
  data: gear_alert_buff

- prefab: creature
  type: poke, gear_buff
  filter: gear_alert_right
  data: gear_alert_buff

- prefab: creature
  type: state, *
  filter: gear_alert_left_not_tamed
  objects:
  - Player, 15
  poke:
  - prefab: Player
    limit: 1
    maxDistance: 30
    parameter: p_player_noise
  - self: true
    delay: 2
    parameter: p_scout_yell_loop

- prefab: creature
  type: state, *
  filter: gear_alert_right_not_tamed
  objects:
  - Player, 15
  poke:
  - prefab: Player
    limit: 1
    maxDistance: 30
    parameter: p_player_noise
  - self: true
    delay: 2
    parameter: p_scout_yell_loop

- prefab: Player
  type: poke, p_player_noise
  objectRpc:
  - name: RPC_AddNoise
    1: float, <float_noise>*2

- prefab: creature
  type: poke, p_scout_yell_loop
  objects:
  - Player, 50
  spawns:
  - vfx_blocked, 0,0,1.3
  - vfx_perfectblock, 0,0,1.3
  - sfx_fallenvalkyrie_idle, 0,0,0, 0,0,0, d_sfx_scout_yell, 0
  - sfx_fallenvalkyrie_taunt, 0,0,0, 0,0,0, d_sfx_scout_yell, 0.2
  - sfx_fallenvalkyrie_screech, 0,0,0, 0,0,0, d_sfx_scout_yell, 0.4
  poke:
  - self: true
    delay: 3.3
    parameter: p_scout_yell_loop

- prefab: creature
  type: poke, p_scout_yell_loop
  objects:
  - Player, 50
  spawns:
  - vfx_blocked, 0,0,1.3
  - vfx_perfectblock, 0,0,1.3
  - sfx_fallenvalkyrie_idle, 0,0,0, 0,0,0, d_sfx_scout_yell, 0
  - sfx_fallenvalkyrie_taunt, 0,0,0, 0,0,0, d_sfx_scout_yell, 0.2
  - sfx_fallenvalkyrie_screech, 0,0,0, 0,0,0, d_sfx_scout_yell, 0.4
  poke:
  - self: true
    delay: 3.7
    parameter: p_scout_yell_loop

- prefab: creature
  type: poke, p_scout_yell_loop
  objects:
  - Player, 50
  spawns:
  - vfx_blocked, 0,0,1.3
  - vfx_perfectblock, 0,0,1.3
  - sfx_fallenvalkyrie_idle, 0,0,0, 0,0,0, d_sfx_scout_yell, 0
  - sfx_fallenvalkyrie_taunt, 0,0,0, 0,0,0, d_sfx_scout_yell, 0.2
  - sfx_fallenvalkyrie_screech, 0,0,0, 0,0,0, d_sfx_scout_yell, 0.4
  poke:
  - self: true
    delay: 4.3
    parameter: p_scout_yell_loop

###############################################################
# Dverger must be grouped with Dverger Mages so they don't agro the skeletons mages can summon.
- prefab: Dverger
  type: create
  weight: 1E30
  data: allied_group_data

# Mages with StaffSkeleton randomly summon skeleton allies.  Skeletons will die to AE.  Oh well.
- prefab: DvergerMage
  type: state, *
  filter: gear_staff_skeleton
  weight: 0.4
  triggerRules: true
  spawn: Skeleton, allied_group_data

###############################################################
# Charred Mages shield themselves on cast if they're holding a StaffShield.
# Shield only has 5 hp (skill=-39), so good for exactly one hit.  1 minute duration (level=1).
- prefab: Charred_Mage
  type: state, attack_fireaoe
  filter: gear_staff_shield
  objectRpc:
  - name: RPC_Damage
    1: hit, status=Staff_shield level=1 skill=-39
    delay: 2

###############################################################
# Skeleton with offhand StaffIceShards cast frost nova
- prefab: Skeleton
  type: state, attack
  filter: gear_staff_ice_shards
  spawns:
  - sfx_icestaff_start
  - fx_DvergerMage_Nova_ring
  poke:
  - prefab: Player, creature
    parameter: Creature_Frost_Nova
    maxDistance: 4
    delay: 0.8

# player armor reduces damage by a lot, which also reduces slow duration.
# frost resist is common on cloaks and negates slow, so add an SE to ensure slow if not dodged.
- prefab: Player
  type: poke, Creature_Frost_Nova
  spawn: vfx_dragon_ice_hit
  spawnDelay: 0.9
  objectRpc:
  - name: RPC_Damage
    1: hit, frost=190 dodge=true block=true status=SE_Savheim_Slowed

- prefab: creature
  type: poke, Creature_Frost_Nova
  filter: tamed_creatures
  spawn: vfx_dragon_ice_hit
  spawnDelay: 0.9
  objectRpc:
  - name: RPC_Damage
    1: hit, frost=34 dodge=true block=true

#################
# Summon versions
- prefab: BMR_SummonSkeleton
  type: state, attack
  filter: gear_staff_ice_shards
  spawns:
  - sfx_icestaff_start
  - fx_DvergerMage_Nova_ring
  poke:
  - prefab: creature
    parameter: Creature_Frost_Nova_Summon 34
    maxDistance: 4
    delay: 0.8

- prefab: Skeleton_Friendly
  type: state, attack
  filter: gear_staff_ice_shards
  spawns:
  - sfx_icestaff_start
  - fx_DvergerMage_Nova_ring
  poke:
  - prefab: creature
    parameter: Creature_Frost_Nova_Summon 97
    maxDistance: 4
    delay: 0.8

- prefab: creature
  type: poke, Creature_Frost_Nova_Summon
  filter: not_tamed_creatures
  spawn: vfx_dragon_ice_hit
  spawnDelay: 0.9
  objectRpc:
  - name: RPC_Damage
    1: hit, frost=<par1> dodge=true block=true

###############################################################
# Goblins with offhand StaffFireballMini cast fire nova
- prefab: Goblin
  types:
  - state, swing_longsword
  - state, spear_throw
  filter: gear_staff_fireball
  poke:
  - prefab: Player, creature
    parameter: Creature_Fire_Nova
    maxDistance: 3
    delay: 0.7

# player armor reduces damage by a lot, but players are less likely to have fire resist.
- prefab: Player
  type: poke, Creature_Fire_Nova
  spawn: fx_fireball_staff_explosion
  objectRpc:
  - name: RPC_Damage
    1: hit, fire=157 dodge=true block=true

- prefab: creature
  type: poke, Creature_Fire_Nova
  filter: tamed_creatures
  spawn: fx_fireball_staff_explosion
  objectRpc:
  - name: RPC_Damage
    1: hit, fire=47 dodge=true block=true

#################
# Summon version
- prefab: BMR_SummonGoblin
  types:
  - state, swing_longsword
  - state, spear_throw
  filter: gear_staff_fireball
  poke:
  - prefab: creature
    parameter: Creature_Fire_Nova_Summon
    maxDistance: 3
    delay: 0.7

- prefab: creature
  type: poke, Creature_Fire_Nova_Summon
  filter: not_tamed_creatures
  spawn: fx_fireball_staff_explosion
  objectRpc:
  - name: RPC_Damage
    1: hit, fire=47 dodge=true block=true

###############################################################
# Creatures with offhand StaffGreenRoots heal nearby creatures
- prefab: creature
  type: poke, gear_buff
  filter: gear_staffgreenroots_any
  data: gear_greenroots_buff

- prefab: Player, creature
  type: state, *
  weight: 0.1         ### low makes it occur randomly, and also prioritizes other processes
  objects:
  - creature, 30, gear_staffgreenroots_any       # healer nearby?
  poke:
  - prefab: creature
    data: gear_staffgreenroots_t3
    maxDistance: 30
    limit: 1                                     # in case of multiple healers
    parameter: p_greenroots_healer_select 11+<vGreenRootsTickRnd>  ### T3 heal tick value
  - prefab: creature
    data: gear_staffgreenroots_t5
    maxDistance: 30
    limit: 1
    parameter: p_greenroots_healer_select 17+<vGreenRootsTickRnd>  ### T3 heal tick value
  - prefab: creature
    data: gear_staffgreenroots_t7
    maxDistance: 30
    limit: 1
    parameter: p_greenroots_healer_select 25+<vGreenRootsTickRnd>  ### T3 heal tick value

# select healer and set flag to put them on cooldown, then delay heal action
- prefab: creature
  type: poke, p_greenroots_healer_select
  data: d_greenroots_healer_cooldown_set
  injectData: true
  poke:
  - self: true
    delay: 3.7   ### arbitrary delay between triggering action and heal - just meant to make heal feel indepedent of action.
    parameter: p_greenroots_healer <par1>

# healer not tamed - poke untamed creatures nearby to start heal loops
- prefab: creature
  type: poke, p_greenroots_healer
  filter: not_tamed_creatures
  spawns:
  - VFX_Buff_Green, 0.5,0,1.5, 0,0,0, d_empty_data_creatures, 0.4
  - VFX_Buff_Green, -0.1,0.4,1.5, 0,0,0, d_empty_data_creatures, 0.4
  - VFX_Buff_Green, -0.2,-0.3,1.5, 0,0,0, d_empty_data_creatures, 0.4
  - fx_natureweapon_hit, 0,0,1.6, 0,0,0, d_empty_data_creatures, 0.7
  - fx_natureweapon_hit, 0,0,1.8, 0,0,0, d_empty_data_creatures, 0.8
  - fx_natureweapon_hit, 0,0,2.0, 0,0,0, d_empty_data_creatures, 0.9
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, greenroots_heal_pitch_1, 0.65
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, greenroots_heal_pitch_2, 0.8
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, greenroots_heal_pitch_3, 0.95
  objectRpc:
  - name: SetTrigger             # each creature will only use the animation it knows
    target: all
    1: name, attack              # skeleton
  - name: SetTrigger
    target: all
    1: name, attack_mace         # skeleton_poison
  - name: SetTrigger
    target: all
    1: name, swing_longsword     # goblin
  - name: SetTrigger
    target: all
    1: name, attack_fireaoe      # charred_mage
  poke:
  - prefab: creature
    data: not_tamed_creatures
    maxDistance: 12           ### distance from healer to be within heal range
    delay: 1
    parameter: p_greenroots_heal_loop_init <par1>
  - self: true
    delay: 10                 ### cooldown to trigger next heal
    parameter: p_greenroots_healer_cooldown_rst

# healer is tamed - poke players and tamed creatures nearby to start heal loops
- prefab: creature
  type: poke, p_greenroots_healer
  filter: tamed_creatures
  spawns:
  - VFX_Buff_Green, 0.5,0,1.5, 0,0,0, d_empty_data_creatures, 0.4
  - VFX_Buff_Green, -0.1,0.4,1.5, 0,0,0, d_empty_data_creatures, 0.4
  - VFX_Buff_Green, -0.2,-0.3,1.5, 0,0,0, d_empty_data_creatures, 0.4
  - fx_natureweapon_hit, 0,0,1.6, 0,0,0, d_empty_data_creatures, 0.7
  - fx_natureweapon_hit, 0,0,1.8, 0,0,0, d_empty_data_creatures, 0.8
  - fx_natureweapon_hit, 0,0,2.0, 0,0,0, d_empty_data_creatures, 0.9
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, greenroots_heal_pitch_1, 0.65
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, greenroots_heal_pitch_2, 0.8
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, greenroots_heal_pitch_3, 0.95
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, attack
  - name: SetTrigger
    target: all
    1: name, attack_mace
  - name: SetTrigger
    target: all
    1: name, swing_longsword
  - name: SetTrigger
    target: all
    1: name, attack_fireaoe
  poke:
  - prefab: Player
    maxDistance: 12           ### distance from healer to be within heal range
    delay: 1
    parameter: p_greenroots_heal_loop_init <par1>*0.3
  - prefab: creature
    data: tamed_creatures
    maxDistance: 12           ### distance from healer to be within heal range
    delay: 1
    parameter: p_greenroots_heal_loop_init <par1>*0.3
  - self: true
    delay: 10                 ### cooldown to trigger next heal
    parameter: p_greenroots_healer_cooldown_rst

- prefab: creature
  type: poke, p_greenroots_healer_cooldown_rst
  data: d_greenroots_healer_cooldown_rst
  injectData: true

# heal loop init
- prefab: Player, creature
  type: poke, p_greenroots_heal_loop_init
  filter: d_greenroots_heal_inactive             # only allow 1 loop at a time.  tick cnt must be 0 (uninitialized) or 7 (previous loop done).
  data: d_greenroots_heal_tick_cnt_rst           # reset to 1 to prevent double application
  injectData: true
  spawns:
  - VFX_Buff_Green, 0,0,1.5, 0,0,0, d_empty_data_creatures, 0.4
  - fx_natureweapon_hit, 0,0,1.75, 0,0,0, d_empty_data_creatures, 0.7
  - sfx_Potion_frostresist_Start, 0,0,0, 0,0,0, greenroots_heal_pitch_2, 0.7
  poke:
  - self: true
    delay: 1
    parameter: p_greenroots_heal_loop <par1>

# main heal loop
- prefab: Player, creature
  type: poke, p_greenroots_heal_loop
  filter: int, i_greenroots_heal_tick_cnt, 0;6   ### max 6 ticks
  data: d_greenroots_heal_tick_cnt_inc
  injectData: true
  spawns:
  - VFX_Buff_Green, 0,0,1.5, 0,0,0, d_empty_data_creatures, 0
  objectRpc:
  - name: RPC_Heal
    1: float, <par1>
    2: bool, true
  poke:
  - self: true
    delay: 1
    parameter: p_greenroots_heal_loop <par1>

####################################################################
# SUMMONS
####################################################################
# Step 1) On spawn, poke to get to step 2, and poke any other summons to limit to one
- prefab: BMR_SummonNeck, BMR_SummonBoar, BMR_SummonGreydwarf, BMR_SummonSkeleton, BMR_SummonDraugr, BMR_SummonSurtling, BMR_SummonWolf, BMR_SummonUlv, BMR_SummonGoblin, BMR_SummonSeeker, BMR_SummonCharredMelee
  type: create
  weight: 1E30
  poke:
  - prefab: BMR_SummonNeck, BMR_SummonBoar, BMR_SummonGreydwarf, BMR_SummonSkeleton, BMR_SummonDraugr, BMR_SummonSurtling, BMR_SummonWolf, BMR_SummonUlv, BMR_SummonGoblin, BMR_SummonSeeker, BMR_SummonCharredMelee
    parameter: p_bmr_summon_tweaks <float_max_health> <float_RandomSkillFactor>
    delay: 0.1
    maxDistance: 0.1
  - prefab: BMR_SummonNeck, BMR_SummonBoar, BMR_SummonGreydwarf, BMR_SummonSkeleton, BMR_SummonDraugr, BMR_SummonSurtling, BMR_SummonWolf, BMR_SummonUlv, BMR_SummonGoblin, BMR_SummonSeeker, BMR_SummonCharredMelee, Skeleton_Friendly
    parameter: only_one_summon
    minDistance: 0.1
    maxDistance: 5

# special case for StaffSkeleton -> Skeleton_Friendly.  Base game scaling is BM (1, 50, 100) = RSF (1, 2, 3)
- prefab: Skeleton_Friendly
  type: create
  weight: 1E30
  poke:
  - prefab: Skeleton_Friendly
    parameter: p_bmr_summon_tweaks_vanilla <float_max_health> <float_RandomSkillFactor>
    delay: 0.1
    maxDistance: 0.1
  - prefab: BMR_SummonNeck, BMR_SummonBoar, BMR_SummonGreydwarf, BMR_SummonSkeleton, BMR_SummonDraugr, BMR_SummonSurtling, BMR_SummonWolf, BMR_SummonUlv, BMR_SummonGoblin, BMR_SummonSeeker, BMR_SummonCharredMelee, Skeleton_Friendly
    parameter: only_one_summon
    minDistance: 0.1
    maxDistance: 5

- prefab: BMR_SummonNeck, BMR_SummonBoar, BMR_SummonGreydwarf, BMR_SummonSkeleton, BMR_SummonDraugr, BMR_SummonSurtling, BMR_SummonWolf, BMR_SummonUlv, BMR_SummonGoblin, BMR_SummonSeeker, BMR_SummonCharredMelee, Skeleton_Friendly
  type: poke, only_one_summon
  spawn: vfx_corpse_destruction_small
  remove: true

###############################
# Step 2) Fix MagicRevamped Blood Magic scaling (it defaults to 21x damage at skill=100 - yikes!)
- prefab: BMR_SummonNeck, BMR_SummonBoar, BMR_SummonGreydwarf, BMR_SummonSkeleton, BMR_SummonDraugr, BMR_SummonSurtling, BMR_SummonWolf, BMR_SummonUlv, BMR_SummonGoblin, BMR_SummonSeeker, BMR_SummonCharredMelee
  type: poke, p_bmr_summon_tweaks
  data: d_bmr_summon_tweaks
  poke:
  - prefab: <prefab>
    parameter: p_bmr_summon_clothing
    maxDistance: 0.1

# vanilla scaling is 1x, 2x, 3x damage at BM 1, 50, 100.
- prefab: Skeleton_Friendly
  type: poke, p_bmr_summon_tweaks_vanilla
  data: d_bmr_summon_tweaks_vanilla
  poke:
  - prefab: <prefab>
    parameter: p_bmr_summon_clothing
    maxDistance: 0.1

###############################
# Step 3) Clothe and buff creatures that can be clothed
- prefab: BMR_SummonSkeleton
  type: poke, p_bmr_summon_clothing
  data: clothes_skeleton_bmr_summon
  poke:
  - prefab: <prefab>
    parameter: gear_buff <float_RandomSkillFactor>
    delay: 0.1
    maxDistance: 0.1

- prefab: Skeleton_Friendly
  type: poke, p_bmr_summon_clothing
  data: clothes_skeleton_vanilla_summon
  poke:
  - prefab: <prefab>
    parameter: gear_buff <float_RandomSkillFactor>
    delay: 0.1
    maxDistance: 0.1

- prefab: BMR_SummonDraugr
  type: poke, p_bmr_summon_clothing
  data: clothes_draugr_bmr_summon
  poke:
  - prefab: <prefab>
    parameter: gear_buff <float_RandomSkillFactor>
    delay: 0.1
    maxDistance: 0.1

- prefab: BMR_SummonGoblin
  type: poke, p_bmr_summon_clothing
  data: clothes_goblin_bmr_summon
  poke:
  - prefab: <prefab>
    parameter: gear_buff <float_RandomSkillFactor>
    delay: 0.1
    maxDistance: 0.1

- prefab: BMR_SummonCharredMelee
  type: poke, p_bmr_summon_clothing
  data: clothes_charred_melee_bmr_summon
  poke:
  - prefab: <prefab>
    parameter: gear_buff <float_RandomSkillFactor>
    delay: 0.1
    maxDistance: 0.1

###############################################################
# No root effect on Bosses, mini bosses, elites, flying, or swimming creatures.
- prefab: fx_RootAshlands
  type: create
  poke:
  - prefab: Eikthyr, gd_king, Bonemass, Dragon, GoblinKing, SeekerQueen, Fader, Skeleton_Hildir, Fenring_Cultist_Hildir, GoblinBruteBros, GoblinShaman_Hildir, GoblinBrute_Hildir, Charred_Melee_Dyrnwyn, FallenValkyrie, Ghost, Serpent, BonemawSerpent, Wraith, Hatchling, Bat, Deathsquito, Gjall, Volture, Troll, Abomination, StoneGolem, GoblinBrute, Morgen
    maxDistance: 1
    limit: 1
    parameter: p_creature_root_resist

# Immune to root so long as vfx_Smoked persists (handles reapplications, since SE won't trigger fx_RootAshlands again until it falls off)
- prefab: Eikthyr, gd_king, Bonemass, Dragon, GoblinKing, SeekerQueen, Fader, Skeleton_Hildir, Fenring_Cultist_Hildir, GoblinBruteBros, GoblinShaman_Hildir, GoblinBrute_Hildir, Charred_Melee_Dyrnwyn, FallenValkyrie, Ghost, Serpent, BonemawSerpent, Wraith, Hatchling, Bat, Deathsquito, Gjall, Volture, Troll, Abomination, StoneGolem, GoblinBrute, Morgen
  type: poke, p_creature_root_resist
  objects:
  - vfx_Smoked, 0.1
  objectRpc:
  - name: RPC_Damage
    1: hit, status=SE_Savheim_RootResist
  poke:
  - self: true
    delay: 1
    parameter: p_creature_root_resist

###############################################################
# Boss tweaks
#################
# Eikthyr - more aggressive.  Deep North uses different data.
- prefab: Eikthyr
  type: create
  biomes: Meadows, Blackforest, Swamp, Ocean, Mountain, Plains, Mistlands, AshLands
  data: d_eikthyr_ai

#################
# Elder - Tentaroots move around - creepy!  (Thanks, Raaka!)
- prefab: TentaRoot
  type: create
  filter: not_tamed_creatures
  objects:
  - gd_king, 100
  data: TentaRootMover

# Elder - tentaroots slime nearby players when they attack.  (Thanks, Raaka!)
- prefab: TentaRoot
  type: state, *
  poke: 
  - prefab: Player, creature
    limit: 5
    maxDistance: 4.1
    delay: 1.45
    parameter: tentarootslimed
    
- prefab: Player
  type: poke, tentarootslimed
  objectRpc:
  - name: RPC_Damage
    1: hit, status=Slimed dodge=true block=true

- prefab: creature
  type: poke, tentarootslimed
  filter: tamed_creatures
  objectRpc:
  - name: RPC_Damage
    1: hit, status=Slimed dodge=true block=true

# Elder - Fewer Tentaroots in melee range, to make melee more viable
- prefab: TentaRoot
  type: create
  weight: 3
  objects:
  - gd_king, 12
  remove: true

# Elder - extra attacks
- prefab: gd_king
  types:
  - state, stomp0
  weight: 0.4
  poke:
  - self: true
    delay: 1.9
    parameter: p_extra_attack_elder_0

- prefab: gd_king
  types:
  - state, stomp1
  weight: 0.4
  poke:
  - self: true
    delay: 1.9
    parameter: p_extra_attack_elder_1

- prefab: gd_king
  type: poke, p_extra_attack_elder_0
  objects:
  - Player, 5
  - creature, 5, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, stomp1

- prefab: gd_king
  type: poke, p_extra_attack_elder_1
  objects:
  - Player, 5
  - creature, 5, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, stomp0

#################
# Bonemass - faster move and turn speed
- prefab: Bonemass
  type: create
  data: d_bonemass_ai

# Bonemass - extra attacks
- prefab: Bonemass
  types:
  - state, punch0
  weight: 0.4
  poke:
  - self: true
    delay: 1.9
    parameter: p_extra_attack_bonemass_0

- prefab: Bonemass
  types:
  - state, punch1
  weight: 0.4
  poke:
  - self: true
    delay: 1.9
    parameter: p_extra_attack_bonemass_1

- prefab: Bonemass
  type: poke, p_extra_attack_bonemass_0
  objects:
  - Player, 7
  - creature, 7, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, punch1

- prefab: Bonemass
  type: poke, p_extra_attack_bonemass_1
  objects:
  - Player, 7
  - creature, 7, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, punch0

# Bonemass - chance to spawn Rancid Remains when spawning others
- prefab: bonemass_throw_projectile
  type: destroy
  weight: 0.2
  spawn: Skeleton_Poison
  triggerRules: true

# Bonemass - chance to spawn Surtlings when spawning others
- prefab: bonemass_throw_projectile
  type: destroy
  weight: 0.2
  spawn: Surtling
  triggerRules: true

# Bonemass AOE destroys nearby structures.  no more hiding in trees!
- prefab: Bonemass
  type: state, aoe
  poke:
  - prefab: Piece
    maxDistance: 100
    delay: 5
    parameter: p_bonemass_acid_piece_init

# except portals.  leave those alone.
- prefab: portal_wood, portal_stone
  type: poke, p_bonemass_acid_piece_init
  weight: 1E30

# everything else though... bye!
- prefab: Piece
  type: poke, p_bonemass_acid_piece_init
  poke:
  - self: true
    parameter: p_bonemass_acid_piece_dmg <randi_5_9> <randi_5_9> <randi_1_3>

- prefab: Piece
  type: poke, p_bonemass_acid_piece_dmg
  objects:
  - Bonemass, 100
  objectRpc:
  - name: RPC_Damage
    1: hit, chop=<par1> pickaxe=<par2>
  poke:
  - self: true
    parameter: p_bonemass_acid_piece_vfx
  - self: true
    delay: <par3>
    parameter: p_bonemass_acid_piece_dmg <randi_5_19> <randi_5_19> <randi_1_5>

- prefab: Piece
  type: poke, p_bonemass_acid_piece_vfx
  weight: 0.05
  spawn: vfx_poisonarrow_hit

#################
# Moder - faster movement when grounded
- prefab: Dragon
  type: create
  data: d_moder_ai

# Moder - Ice Blocks have a chance to spawn an Ulv if not destroyed.  more players makes them pop sooner.
# 1 player present, so slowest ulv spawning
- prefab: IceBlocker
  type: create
  objects:
  - Dragon, 100
  - Player, 100
  objectsLimit: 2
  bannedObjects:
  - Player, 100
  bannedObjectsLimit: 2
  poke:
  - self: true
    delay: 4                                     ### time until IceBlockers can start popping Ulvs
    parameter: p_iceblock_spawn_ulv_loop 2.3     ### time between chances to pop ulvs

# 2 players present
- prefab: IceBlocker
  type: create
  objects:
  - Dragon, 100
  - Player, 100
  objectsLimit: 3
  bannedObjects:
  - Player, 100
  bannedObjectsLimit: 3
  poke:
  - self: true
    delay: 3                                     ### time until IceBlockers can start popping Ulvs
    parameter: p_iceblock_spawn_ulv_loop 1.8     ### time between chances to pop ulvs

# 3 players present
- prefab: IceBlocker
  type: create
  objects:
  - Dragon, 100
  - Player, 100
  objectsLimit: 4
  bannedObjects:
  - Player, 100
  bannedObjectsLimit: 4
  poke:
  - self: true
    delay: 2                                     ### time until IceBlockers can start popping Ulvs
    parameter: p_iceblock_spawn_ulv_loop 1.3     ### time between chances to pop ulvs

# 4 players present
- prefab: IceBlocker
  type: create
  objects:
  - Dragon, 100
  - Player, 100
  objectsLimit: 5
  bannedObjects:
  - Player, 100
  bannedObjectsLimit: 5
  poke:
  - self: true
    delay: 1                                     ### time until IceBlockers can start popping Ulvs
    parameter: p_iceblock_spawn_ulv_loop 0.8     ### time between chances to pop ulvs

# 5+ players present
- prefab: IceBlocker
  type: create
  objects:
  - Dragon, 100
  - Player, 100
  objectsLimit: 6
  poke:
  - self: true
    delay: 0                                     ### time until IceBlockers can start popping Ulvs
    parameter: p_iceblock_spawn_ulv_loop 0.3     ### time between chances to pop ulvs

- prefab: IceBlocker
  type: poke, p_iceblock_spawn_ulv_loop
  poke:
  - self: true
    delay: <par1>
    parameter: p_iceblock_spawn_ulv_loop <par1>
  - self: true
    parameter: p_iceblock_spawn_ulv_spawn

- prefab: IceBlocker
  type: poke, p_iceblock_spawn_ulv_spawn
  weight: 0.1
  remove: true
  spawns:
  - Ulv, 0,0,0, 0,0,0, d_ulv_wakeup, 0.5
  - vfx_iceblocker_destroyed
  - sfx_ice_destroyed
  - fx_iceshard_hit
  - fx_HildirChest_Unlock, 0,0,0, 0,0,0, d_sfx_silent_creatures
  - vfx_Potion_stamina_medium
  triggerRules: true

- prefab: Ulv
  type: state, wakeup
  objects:
  - Dragon, 100
  spawns:
  - sfx_wolf_attack, 0,0,0, 0,0,0, d_ulv_howl_pitch

# Moder - extra attacks
- prefab: Dragon
  types:
  - state, attack_claw_left
  weight: 0.4
  poke:
  - self: true
    delay: 2.2
    parameter: p_extra_attack_moder_left

- prefab: Dragon
  types:
  - state, attack_claw_right
  weight: 0.4
  poke:
  - self: true
    delay: 2.2
    parameter: p_extra_attack_moder_right

- prefab: Dragon
  type: poke, p_extra_attack_moder_left
  objects:
  - Player, 9
  - creature, 9, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, attack_claw_right

- prefab: Dragon
  type: poke, p_extra_attack_moder_right
  objects:
  - Player, 9
  - creature, 9, tamed_creatures
  objectsLimit: 1
  objectRpc:
  - name: SetTrigger
    target: all
    1: name, attack_claw_left

# Moder taunt bursts all remaining IceBlockers for AE dmg & slow to any nearby players or tames
- prefab: Dragon
  types:
  - state, attack_taunt
  spawn: fx_DvergerMage_Mistile_attack, 0,5,2, 0,0,0, d_empty_data_creatures, 2.5
  poke:
  - prefab: IceBlocker
    maxDistance: 100
    delay: 3
    parameter: p_iceblock_burst_init

- prefab: IceBlocker
  type: poke, p_iceblock_burst_init
  poke:
  - self: true
    parameter: p_iceblock_burst_rndDly <randf_0_0.7>

- prefab: IceBlocker
  type: poke, p_iceblock_burst_rndDly
  poke:
  - self: true
    delay: <par1>
    parameter: p_iceblock_burst

- prefab: IceBlocker
  type: poke, p_iceblock_burst
  spawns:
  - vfx_iceblocker_destroyed
  - sfx_ice_destroyed
  - fx_iceshard_hit
  - fx_DvergerMage_Mistile_attack
  - fx_DvergerMage_Mistile_die
  remove: true
  poke:
  - prefab: Player
    maxDistance: 7
    parameter: p_iceblock_burst_dmg 210+<vModerIceBlockerDmgRnd>
  - prefab: creature
    data: tamed_creatures
    maxDistance: 7
    parameter: p_iceblock_burst_dmg 35+<vModerIceBlockerDmgRnd>

- prefab: Player
  type: poke, p_iceblock_burst_dmg
  spawns:
  - fx_iceshard_hit
  objectRpc:
  - name: RPC_Damage
    1: hit, frost=<par1> dodge=true block=true status=SE_Savheim_Slowed

- prefab: creature
  type: poke, p_iceblock_burst_dmg
  spawns:
  - fx_iceshard_hit
  objectRpc:
  - name: RPC_Damage
    1: hit, frost=<par1> dodge=true block=true

# Players or tames hit by frost breath cause an IceBlocker to spawn.
- prefab: vfx_Frost
  type: create
  objects:
  - Dragon, 100
  - vfx_dragon_coldbreath, 20
  poke:
  - prefab: Player
    maxDistance: 1
    limit: 1
    parameter: p_iceblock_spawn
  - prefab: creature
    data: tamed_creatures
    maxDistance: 1
    limit: 1
    parameter: p_iceblock_spawn

- prefab: Player, creature
  type: poke, p_iceblock_spawn
  spawns:
  - IceBlocker, 0,-1,0
  triggerRules: true
